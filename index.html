<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Climate Engine (ACE)</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDCPLODfmk0K9N3pLp9p2fb7humG2smuGY",
      authDomain: "klimakoiq.firebaseapp.com",
      projectId: "klimakoiq",
      storageBucket: "klimakoiq.firebasestorage.app",
      messagingSenderId: "752191906651",
      appId: "1:752191906651:web:b9c8f74fcdb5da5f73f07e",
      measurementId: "G-Y5CDVM876W"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    
    // Make auth available globally
    window.firebaseAuth = auth;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
    window.signOut = signOut;
    window.onAuthStateChanged = onAuthStateChanged;
  </script>
  
  <!-- Visualization Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.0"></script>
  <script src="https://cdn.plot.ly/plotly-2.18.0.min.js"></script>
  
  <style>
    :root {
      --primary: #0070f3;
      --primary-light: #3291ff;
      --primary-dark: #0051a5;
      --secondary: #7928ca;
      --secondary-light: #a855f7;
      --accent: #ff0080;
      --accent-light: #ff4081;
      --success: #00d924;
      --warning: #f5a623;
      --danger: #e00;
      --background: #fafafa;
      --surface: #ffffff;
      --border: #eaeaea;
      --text-primary: #000000;
      --text-secondary: #666666;
      --text-muted: #999999;
      --shadow-small: 0 2px 4px rgba(0,0,0,0.1);
      --shadow-medium: 0 4px 12px rgba(0,0,0,0.15);
      --shadow-large: 0 8px 30px rgba(0,0,0,0.12);
      --radius: 8px;
      --radius-large: 12px;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: var(--background);
      padding: 24px;
      color: var(--text-primary);
      line-height: 1.5;
      margin: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Authentication Overlay */
    #authOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--background);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #authOverlay.hidden {
      display: none;
    }
    
    .auth-container {
      background: var(--surface);
      padding: 40px;
      border-radius: var(--radius-large);
      box-shadow: var(--shadow-large);
      width: 100%;
      max-width: 400px;
      border: 1px solid var(--border);
    }
    
    .auth-logo {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .auth-logo .logo {
      background: linear-gradient(45deg, var(--primary), var(--primary-dark));
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 20px;
      margin: 0 auto 15px;
      box-shadow: 0 4px 8px rgba(0,123,255,0.3);
    }
    
    .auth-logo h1 {
      margin: 0 0 5px 0;
      font-size: 24px;
      color: var(--text-primary);
    }
    
    .auth-logo .subtitle {
      color: var(--text-secondary);
      font-size: 14px;
      margin: 0;
    }
    
    .auth-form-group {
      margin-bottom: 20px;
    }
    
    .auth-form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .auth-form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 16px;
      transition: border-color 0.2s;
      box-sizing: border-box;
    }
    
    .auth-form-group input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .auth-btn {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-bottom: 15px;
    }
    
    .auth-btn:hover {
      background: var(--primary-dark);
    }
    
    .auth-btn:disabled {
      background: var(--text-secondary);
      cursor: not-allowed;
    }
    
    .auth-toggle {
      text-align: center;
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .auth-toggle-link {
      color: var(--primary);
      cursor: pointer;
      text-decoration: underline;
    }
    
    .auth-toggle-link:hover {
      color: var(--primary-dark);
    }
    
    .auth-message {
      margin-top: 15px;
      padding: 10px;
      border-radius: var(--radius);
      font-size: 14px;
      text-align: center;
    }
    
    .auth-message.error {
      background: #fee;
      color: var(--danger);
      border: 1px solid #fcc;
    }
    
    .auth-message.success {
      background: #efe;
      color: var(--success);
      border: 1px solid #cfc;
    }
    
    /* Main App Styles (copy from klimakoiq_static.html) */
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .header-content {
      flex: 1;
    }
    
    .user-welcome {
      color: rgba(255,255,255,0.9);
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    
    .logout-btn {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
      margin-left: 15px;
    }
    
    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .unit-toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    
    .unit-toggle {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 25px;
      padding: 8px;
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .unit-toggle button {
      background: transparent;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      margin: 0;
    }
    
    .unit-toggle button.active {
      background: rgba(255, 255, 255, 0.9);
      color: var(--primary-dark);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .unit-toggle button:hover:not(.active) {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .unit-label {
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.9rem;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <!-- Authentication Overlay -->
  <div id="authOverlay">
    <div class="auth-container">
      <div class="auth-logo">
        <div class="logo">ACE</div>
        <h1>Advanced Climate Engine</h1>
        <p class="subtitle">Professional EPW Climate Analysis Tool</p>
      </div>
      
      <form id="authForm">
        <div class="auth-form-group">
          <label for="email">Email</label>
          <input type="email" id="email" required>
        </div>
        
        <div class="auth-form-group">
          <label for="password">Password</label>
          <input type="password" id="password" required>
        </div>
        
        <button type="submit" class="auth-btn" id="authSubmit">Sign In</button>
        
        <div class="auth-toggle">
          <span id="authToggleText">Don't have an account?</span>
          <span class="auth-toggle-link" id="authToggleLink">Sign up here</span>
        </div>
        
        <div id="authMessage"></div>
      </form>
    </div>
  </div>

  <!-- Main Application (hidden until authenticated) -->
  <div id="mainApp" style="display: none;">
    <div class="container">
      <header>
        <div class="header-content">
          <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
            <div style="background: linear-gradient(45deg, #007bff, #0056b3); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; box-shadow: 0 4px 8px rgba(0,123,255,0.3);">
              ACE
            </div>
            <div>
              <h2 style="margin: 0; color: #2c3e50;">Advanced Climate Engine</h2>
              <p style="margin: 5px 0 0 0; color: #495057; font-style: italic; font-size: 0.9rem; font-weight: 500;">The ultimate tool for EPW-based climate analysis, design, and visualization</p>
            </div>
          </div>
          <div class="user-welcome" id="userWelcome">Welcome!</div>
          <h3 id="weatherFileInfo">Weather File: Not Loaded</h3>
        </div>
        <div style="display: flex; align-items: center;">
          <div class="unit-toggle-container">
            <span class="unit-label">Units:</span>
            <div class="unit-toggle">
              <button id="siButton" onclick="window.toggleToSI();">S.I.</button>
              <button id="imperialButton" class="active" onclick="window.toggleToImperial();">Imperial</button>
            </div>
          </div>
          <button class="logout-btn" id="logoutButton">Logout</button>
        </div>
      </header>

      <!-- File Upload Section -->
      <div id="uploadSection" style="border: 2px dashed #999; padding: 30px; margin-bottom: 20px; text-align: center; background: white; border-radius: 10px; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);">
        <p>Drag & Drop your EPW file here or use the button below:</p>
        <input type="file" id="fileInput" accept=".epw"><br>
        <label><strong>Select Weather Parameter:</strong></label><br>
        <select id="parameterSelect" disabled></select><br>
        <div class="button-group">
          <button id="downloadSelectedCSV" disabled>Download Selected Parameter</button>
          <button id="downloadAllCSV" disabled>Download All Parameters</button>
          <button id="downloadBinCSV" disabled>Download Selected Parameter Bins</button>
          <button id="downloadReport" class="accent" disabled>Download Text Report</button>
          <button id="downloadPDFReport" class="accent" disabled>Download PDF Report</button>
        </div>
      </div>

      <!-- Add a placeholder for the full ACE interface -->
      <div id="aceInterface">
        <p style="text-align: center; color: var(--text-secondary); font-style: italic;">
          Climate analysis interface will be loaded here after authentication...
        </p>
      </div>
    </div>
  </div>

  <script>
    // Authentication state management
    let isSignUp = false;
    let currentUser = null;

    // Initialize authentication
    document.addEventListener('DOMContentLoaded', function() {
      initializeAuth();
    });

    function initializeAuth() {
      const authForm = document.getElementById('authForm');
      const authSubmit = document.getElementById('authSubmit');
      const authToggleText = document.getElementById('authToggleText');
      const authToggleLink = document.getElementById('authToggleLink');
      const authMessage = document.getElementById('authMessage');
      const logoutButton = document.getElementById('logoutButton');

      // Toggle between sign in and sign up
      authToggleLink.addEventListener('click', function() {
        isSignUp = !isSignUp;
        if (isSignUp) {
          authSubmit.textContent = 'Sign Up';
          authToggleText.textContent = 'Already have an account?';
          authToggleLink.textContent = 'Sign in here';
        } else {
          authSubmit.textContent = 'Sign In';
          authToggleText.textContent = "Don't have an account?";
          authToggleLink.textContent = 'Sign up here';
        }
        authMessage.innerHTML = '';
      });

      // Handle form submission
      authForm.addEventListener('submit', function(e) {
        e.preventDefault();
        handleAuth();
      });

      // Handle logout
      logoutButton.addEventListener('click', function() {
        handleLogout();
      });

      // Check for existing authentication
      if (window.onAuthStateChanged && window.firebaseAuth) {
        window.onAuthStateChanged(window.firebaseAuth, function(user) {
          if (user) {
            currentUser = user;
            showMainApp();
          } else {
            currentUser = null;
            showAuthOverlay();
          }
        });
      } else {
        // Fallback: show configuration message
        showConfigurationMessage();
      }
    }

    async function handleAuth() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const authMessage = document.getElementById('authMessage');
      const authSubmit = document.getElementById('authSubmit');

      if (!window.firebaseAuth) {
        showConfigurationMessage();
        return;
      }

      authSubmit.disabled = true;
      authSubmit.textContent = isSignUp ? 'Creating Account...' : 'Signing In...';

      try {
        if (isSignUp) {
          await window.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
          authMessage.innerHTML = '<div class="auth-message success">Account created successfully!</div>';
        } else {
          await window.signInWithEmailAndPassword(window.firebaseAuth, email, password);
          authMessage.innerHTML = '<div class="auth-message success">Signed in successfully!</div>';
        }
      } catch (error) {
        authMessage.innerHTML = `<div class="auth-message error">${error.message}</div>`;
      } finally {
        authSubmit.disabled = false;
        authSubmit.textContent = isSignUp ? 'Sign Up' : 'Sign In';
      }
    }

    async function handleLogout() {
      if (window.signOut && window.firebaseAuth) {
        try {
          await window.signOut(window.firebaseAuth);
        } catch (error) {
          console.error('Logout error:', error);
        }
      }
    }

    function showMainApp() {
      document.getElementById('authOverlay').classList.add('hidden');
      document.getElementById('mainApp').style.display = 'block';
      
      if (currentUser) {
        const userWelcome = document.getElementById('userWelcome');
        userWelcome.textContent = `Welcome, ${currentUser.email}!`;
      }
      
      // Load the full ACE interface
      loadACEInterface();
    }

    function showAuthOverlay() {
      document.getElementById('authOverlay').classList.remove('hidden');
      document.getElementById('mainApp').style.display = 'none';
    }

    function showConfigurationMessage() {
      const authMessage = document.getElementById('authMessage');
      authMessage.innerHTML = `
        <div class="auth-message error">
          <strong>Firebase Configuration Required</strong><br>
          Please configure Firebase Authentication to enable user management.
          <br><br>
          <a href="#" onclick="showInstructions()" style="color: var(--primary);">View Setup Instructions</a>
        </div>
      `;
    }

    function showInstructions() {
      alert(`Firebase Setup Instructions:

1. Go to https://console.firebase.google.com/
2. Create a new project or select existing project
3. Enable Authentication > Email/Password
4. Get your Firebase config from Project Settings
5. Replace the firebaseConfig object in this HTML file
6. Add your domain to authorized domains in Firebase

Your domain: ${window.location.hostname}`);
    }

    function loadACEInterface() {
      // This is where you would load the full ACE interface
      // For now, we'll show a placeholder
      const aceInterface = document.getElementById('aceInterface');
      aceInterface.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <h3>🎉 Authentication Successful!</h3>
          <p>Welcome to the Advanced Climate Engine. The full climate analysis interface would be loaded here.</p>
          <p><strong>Next Steps:</strong></p>
          <ol style="text-align: left; max-width: 500px; margin: 0 auto;">
            <li>Configure Firebase Authentication</li>
            <li>Copy the full ACE interface from klimakoiq_static.html</li>
            <li>Replace this placeholder section</li>
          </ol>
        </div>
      `;
    }

    // Placeholder unit toggle functions
    window.toggleToSI = function() {
      document.getElementById('siButton').classList.add('active');
      document.getElementById('imperialButton').classList.remove('active');
    };

    window.toggleToImperial = function() {
      document.getElementById('siButton').classList.remove('active');
      document.getElementById('imperialButton').classList.add('active');
    };
  </script>
</body>
</html>
