<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced EPW Climate Analysis Tool</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.0"></script>
  <script src="https://cdn.plot.ly/plotly-2.18.0.min.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --secondary: #0f766e;
      --secondary-light: #14b8a6;
      --accent: #7c3aed;
      --accent-light: #8b5cf6;
      --success: #16a34a;
      --warning: #ca8a04;
      --danger: #dc2626;
      --light: #f8fafc;
      --dark: #1e293b;
      --gray: #64748b;
      --gray-light: #94a3b8;
      --gray-lighter: #e2e8f0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f4f8;
      padding: 20px;
      color: var(--dark);
      line-height: 1.6;
      margin: 0;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .header-content {
      flex: 1;
    }
    
    .unit-toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    
    .unit-toggle {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 25px;
      padding: 8px;
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .unit-toggle button {
      background: transparent;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      margin: 0;
    }
    
    .unit-toggle button.active {
      background: rgba(255, 255, 255, 0.9);
      color: var(--primary-dark);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .unit-toggle button:hover:not(.active) {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .unit-label {
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    h2, h3 {
      margin: 0 0 10px;
    }
    
    #uploadSection {
      border: 2px dashed var(--gray-light);
      padding: 30px;
      margin-bottom: 20px;
      text-align: center;
      background: white;
      border-radius: 10px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    #uploadSection:hover, #uploadSection.dragover {
      border-color: var(--primary-light);
      background: var(--light);
    }
    
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    select, button, input[type="file"], input[type="number"] {
      margin-top: 10px;
      padding: 10px 15px;
      border-radius: 5px;
      border: 1px solid var(--gray-lighter);
      background: white;
      transition: all 0.2s;
    }
    
    button {
      background: var(--primary-light);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    
    button:hover {
      background: var(--primary);
    }
    
    button:disabled {
      background: var(--gray-light);
      cursor: not-allowed;
    }
    
    button.secondary {
      background: var(--secondary-light);
    }
    
    button.secondary:hover {
      background: var(--secondary);
    }
    
    button.accent {
      background: var(--accent-light);
    }
    
    button.accent:hover {
      background: var(--accent);
    }
    
    select {
      width: 100%;
      max-width: 400px;
    }
    
    .chart-wrapper {
      position: relative;
      height: 400px;
      margin: 20px 0;
    }
    
    .tabs {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 15px;
      border-bottom: 1px solid var(--gray-lighter);
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 500;
      margin-right: 5px;
    }
    
    .tab.active {
      border-bottom-color: var(--primary-light);
      color: var(--primary);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .stat-card {
      background: var(--light);
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid var(--primary-light);
    }
    
    .stat-card.highlight {
      border-left-color: var(--accent);
    }
    
    .stat-card.warning {
      border-left-color: var(--warning);
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary-dark);
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--gray);
    }
    
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary-light);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: var(--dark);
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.8rem;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    
    .climate-zone-card {
      background: linear-gradient(135deg, #f6f8fa, #e2e8f0);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      border-left: 5px solid var(--primary);
    }
    
    .climate-zone-title {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--primary-dark);
    }
    
    .climate-zone-description {
      margin-bottom: 15px;
      color: var(--dark);
    }
    
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .controls-group {
      margin-bottom: 15px;
      padding: 10px;
      background: var(--light);
      border-radius: 5px;
    }
    
    .controls-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: bold;
      margin-right: 5px;
      margin-bottom: 5px;
    }
    
    .badge-primary {
      background-color: var(--primary-light);
      color: white;
    }
    
    .badge-secondary {
      background-color: var(--secondary-light);
      color: white;
    }
    
    .badge-accent {
      background-color: var(--accent-light);
      color: white;
    }
    
    .badge-warning {
      background-color: var(--warning);
      color: white;
    }
    
    .badge-success {
      background-color: var(--success);
      color: white;
    }
    
    .badge-danger {
      background-color: var(--danger);
      color: white;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    
    table th, table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--gray-lighter);
    }
    
    table th {
      background-color: var(--light);
      font-weight: 600;
    }
    
    table tr:hover {
      background-color: var(--light);
    }
    
    .info-icon {
      color: var(--primary-light);
      cursor: help;
      margin-left: 5px;
    }
    
    /* Design Recommendations Styles */
    .recommendations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }
    
    .recommendation-card {
      background: white;
      border: 1px solid var(--gray-lighter);
      border-radius: 8px;
      padding: 20px;
      transition: box-shadow 0.2s ease;
    }
    
    .recommendation-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .recommendation-card.priority-high {
      border-left: 4px solid var(--danger);
    }
    
    .recommendation-card.priority-medium {
      border-left: 4px solid var(--warning);
    }
    
    .recommendation-card.priority-low {
      border-left: 4px solid var(--primary);
    }
    
    .rec-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .rec-category {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-weight: 500;
    }
    
    .rec-priority {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .rec-priority.priority-high {
      background-color: var(--danger);
      color: white;
    }
    
    .rec-priority.priority-medium {
      background-color: var(--warning);
      color: white;
    }
    
    .rec-priority.priority-low {
      background-color: var(--primary);
      color: white;
    }
    
    .recommendation-card h5 {
      margin: 0 0 10px 0;
      color: var(--text-dark);
      font-size: 1.1rem;
    }
    
    .recommendation-card p {
      margin: 0;
      color: var(--text-muted);
      line-height: 1.5;
    }
    
    /* Climate Summary Styles */
    .climate-summary-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }
    
    .summary-section {
      background: var(--light);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--gray-lighter);
    }
    
    .summary-section h5 {
      margin: 0 0 15px 0;
      color: var(--text-dark);
      font-size: 1.1rem;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 5px;
    }
    
    .climate-zone-display {
      text-align: center;
    }
    
    .climate-zone-display strong {
      display: block;
      font-size: 1.3rem;
      color: var(--primary);
      margin-bottom: 10px;
    }
    
    .climate-chars {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .climate-primary, .climate-secondary {
      padding: 8px 12px;
      border-radius: 6px;
      text-align: center;
      font-weight: 500;
    }
    
    .climate-primary {
      background-color: var(--primary);
      color: white;
    }
    
    .climate-secondary {
      background-color: var(--secondary);
      color: white;
    }
    
    .design-priorities, .energy-implications {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    
    .design-priorities li, .energy-implications li {
      padding: 8px 0;
      border-bottom: 1px solid var(--gray-lighter);
      position: relative;
      padding-left: 20px;
    }
    
    .design-priorities li:before, .energy-implications li:before {
      content: '•';
      color: var(--primary);
      font-weight: bold;
      position: absolute;
      left: 0;
    }
    
    .design-priorities li:last-child, .energy-implications li:last-child {
      border-bottom: none;
    }
    
    /* Statistical Analysis Styles */
    .stats-analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }
    
    .analysis-section {
      background: white;
      border: 1px solid var(--gray-lighter);
      border-radius: 8px;
      padding: 20px;
    }
    
    .analysis-section h5 {
      margin: 0 0 15px 0;
      color: var(--text-dark);
      font-size: 1.1rem;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 5px;
    }
    
    .stat-grid, .correlation-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
    }
    
    .stat-item, .corr-item {
      padding: 10px;
      background: var(--light);
      border-radius: 6px;
      text-align: center;
    }
    
    .corr-value {
      display: block;
      font-size: 1.2rem;
      font-weight: bold;
      margin-top: 5px;
    }
    
    .corr-value.strong {
      color: var(--success);
    }
    
    .corr-value.weak {
      color: var(--warning);
    }
    
    .corr-interpretation {
      margin-top: 10px;
      font-size: 0.9rem;
      color: var(--text-muted);
      text-align: center;
    }
    
    .corr-explanation {
      font-size: 0.8rem;
      color: var(--primary);
      margin-top: 5px;
      font-style: italic;
    }
    
    .regression-results {
      background: var(--light);
      padding: 15px;
      border-radius: 6px;
    }
    
    .reg-model {
      margin-bottom: 20px;
      padding: 15px;
      background: white;
      border-radius: 6px;
      border-left: 4px solid var(--primary);
    }
    
    .reg-equation {
      font-family: 'Courier New', monospace;
      background: var(--light);
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    
    .climate-context {
      margin-top: 15px;
      padding: 10px;
      background: var(--light);
      border-radius: 6px;
      font-size: 0.9rem;
      color: var(--text-muted);
      text-align: center;
    }
    
    .traits-container {
      margin-top: 15px;
    }
    
    .trait-section {
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid;
    }
    
    .good-traits {
      background: #f0f9f0;
      border-left-color: #28a745;
    }
    
    .bad-traits {
      background: #fdf2f2;
      border-left-color: #dc3545;
    }
    
    .neutral-traits {
      background: #f8f9fa;
      border-left-color: #6c757d;
    }
    
    .trait-section h6 {
      margin: 0 0 10px 0;
      font-size: 1rem;
      font-weight: 600;
    }
    
    .trait-section ul {
      margin: 0;
      padding-left: 20px;
    }
    
    .trait-section li {
      margin-bottom: 8px;
      line-height: 1.4;
    }
    
    .reg-rsquared {
      text-align: center;
    }
    
    .rsquared-interpretation {
      display: block;
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-top: 5px;
    }
    
    .seasonal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
    }
    
    .season-card {
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      color: white;
      font-weight: 500;
    }
    
    .season-card.winter {
      background: linear-gradient(135deg, #3b82f6, #1e40af);
    }
    
    .season-card.spring {
      background: linear-gradient(135deg, #10b981, #047857);
    }
    
    .season-card.summer {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }
    
    .season-card.autumn {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    
    .season-card h6 {
      margin: 0 0 10px 0;
      font-size: 1rem;
    }
    
    .season-card div {
      font-size: 0.9rem;
      margin-bottom: 5px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .unit-toggle-container {
        width: 100%;
        justify-content: center;
        margin-top: 15px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      button {
        width: 100%;
        margin-bottom: 10px;
      }
      
      .two-column {
        grid-template-columns: 1fr;
      }
      
      .tabs {
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 5px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-content">
        <h2>Advanced EPW Climate Analysis Tool</h2>
        <h3 id="weatherFileInfo">Weather File: Not Loaded</h3>
      </div>
      <div class="unit-toggle-container">
        <span class="unit-label">Units:</span>
        <div class="unit-toggle">
          <button id="siButton" class="active">S.I.</button>
          <button id="imperialButton">Imperial</button>
        </div>
      </div>
    </header>

    <div id="uploadSection">
      <p>Drag & Drop your EPW file here or use the button below:</p>
      <input type="file" id="fileInput" accept=".epw"><br>
      <label><strong>Select Weather Parameter:</strong></label><br>
      <select id="parameterSelect" disabled></select><br>
      <div class="button-group">
        <button id="downloadSelectedCSV" disabled>Download Selected Parameter</button>
        <button id="downloadAllCSV" disabled>Download All Parameters</button>
        <button id="downloadBinCSV" disabled>Download Selected Parameter Bins</button>
        <button id="downloadReport" class="accent" disabled>Download Full Climate Analysis Report</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="timeseries">Time Series</div>
      <div class="tab" data-tab="histogram">Histogram</div>
      <div class="tab" data-tab="psychro">Psychrometric</div>
      <div class="tab" data-tab="climate">Climate Analysis</div>
      <div class="tab" data-tab="hdd-cdd">HDD/CDD</div>
      <div class="tab" data-tab="advanced">Advanced Metrics</div>
    </div>

    <div id="timeseries" class="tab-content card active">
      <div class="chart-wrapper">
        <canvas id="weatherChart"></canvas>
      </div>
      <div class="controls">
        <button id="resetZoom">Reset Zoom</button>
        <button id="toggleDaily">Toggle Daily/Hourly</button>
        <button id="toggleMonthly">Toggle Monthly View</button>
      </div>
    </div>

    <div id="histogram" class="tab-content card">
      <div class="chart-wrapper">
        <canvas id="histogramChart"></canvas>
      </div>
      <div class="controls">
        <label for="binCount">Bin Count:</label>
        <input type="range" id="binCount" min="5" max="50" value="20">
        <span id="binCountValue">20</span>
      </div>
    </div>

    <div id="psychro" class="tab-content card">
      <div id="chart" style="width:100%;height:600px;"></div>
      <div class="controls">
        <button id="toggleComfortZone" class="secondary">Toggle Comfort Zone</button>
        <button id="toggleHumidityLines" class="secondary">Toggle Humidity Lines</button>
      </div>
    </div>

    <div id="climate" class="tab-content card">
      <div class="climate-zone-card">
        <div class="climate-zone-title" id="ashrae-zone">ASHRAE Climate Zone: Loading...</div>
        <div class="climate-zone-description" id="zone-description">Loading climate zone information...</div>
        <div id="climate-badges"></div>
      </div>
      
      <div class="two-column">
        <div class="card">
          <h4>Temperature Analysis</h4>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="avg-temp">-</div>
              <div class="stat-label" id="avg-temp-label">Annual Average Temperature (°C)</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="max-temp">-</div>
              <div class="stat-label" id="max-temp-label">Maximum Temperature (°C)</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="min-temp">-</div>
              <div class="stat-label" id="min-temp-label">Minimum Temperature (°C)</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="temp-range">-</div>
              <div class="stat-label" id="temp-range-label">Annual Temperature Range (°C)</div>
            </div>
          </div>
          
          <h4>Humidity Analysis</h4>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="avg-rh">-</div>
              <div class="stat-label">Average Relative Humidity (%)</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="high-humidity-hours">-</div>
              <div class="stat-label">Hours > 70% RH</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="low-humidity-hours">-</div>
              <div class="stat-label">Hours < 30% RH</div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <h4>Solar Radiation Analysis</h4>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="annual-solar">-</div>
              <div class="stat-label" id="annual-solar-label">Annual Solar Radiation (kWh/m²)</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="peak-solar">-</div>
              <div class="stat-label" id="peak-solar-label">Peak Solar Radiation (W/m²)</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="solar-hours">-</div>
              <div class="stat-label">Hours with Solar > 100 W/m²</div>
            </div>
          </div>
          
          <h4>Wind Analysis</h4>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="avg-wind">-</div>
              <div class="stat-label" id="avg-wind-label">Average Wind Speed (m/s)</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="max-wind">-</div>
              <div class="stat-label" id="max-wind-label">Maximum Wind Speed (m/s)</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="prevailing-wind">-</div>
              <div class="stat-label">Prevailing Wind Direction</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="hdd-cdd" class="tab-content card">
      <div class="two-column">
        <div class="card">
          <h4>Heating Degree Days (HDD)</h4>
          <div class="controls-group">
            <label for="hddBase">Base Temperature:</label>
            <input type="number" id="hddBase" value="18" step="0.5">
            <span id="hdd-base-unit">°C</span>
          </div>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="annual-hdd">-</div>
              <div class="stat-label" id="annual-hdd-label">Annual HDD</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="monthly-hdd-max">-</div>
              <div class="stat-label">Peak Monthly HDD</div>
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="hddChart"></canvas>
          </div>
        </div>
        
        <div class="card">
          <h4>Cooling Degree Days (CDD)</h4>
          <div class="controls-group">
            <label for="cddBase">Base Temperature:</label>
            <input type="number" id="cddBase" value="18" step="0.5">
            <span id="cdd-base-unit">°C</span>
          </div>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="annual-cdd">-</div>
              <div class="stat-label" id="annual-cdd-label">Annual CDD</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="monthly-cdd-max">-</div>
              <div class="stat-label">Peak Monthly CDD</div>
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="cddChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div id="advanced" class="tab-content card">
      <div class="two-column">
        <div class="card">
          <h4>Thermal Comfort Metrics</h4>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="comfort-hours">-</div>
              <div class="stat-label">Hours in Comfort Zone</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="overheating-hours">-</div>
              <div class="stat-label">Overheating Hours</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="underheating-hours">-</div>
              <div class="stat-label">Underheating Hours</div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <h4>Extreme Weather Events</h4>
          <div class="stats-grid">
            <div class="stat-card warning">
              <div class="stat-value" id="extreme-heat-days">-</div>
              <div class="stat-label" id="extreme-heat-label">Days > 35°C</div>
            </div>
            <div class="stat-card warning">
              <div class="stat-value" id="extreme-cold-days">-</div>
              <div class="stat-label" id="extreme-cold-label">Days < 0°C</div>
            </div>
            <div class="stat-card highlight">
              <div class="stat-value" id="precipitation-days">-</div>
              <div class="stat-label">Days with Precipitation</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h4>Monthly Climate Summary</h4>
        <table id="monthly-summary">
          <thead>
            <tr>
              <th>Month</th>
              <th id="monthly-avg-temp-header">Avg Temp (°C)</th>
              <th id="monthly-solar-header">Solar (kWh/m²)</th>
              <th>Humidity (%)</th>
              <th id="monthly-wind-header">Wind (m/s)</th>
            </tr>
          </thead>
          <tbody id="monthly-summary-body">
            <!-- Monthly data will be populated here -->
          </tbody>
        </table>
      </div>
      
      <div class="card">
        <h4>Design Recommendations</h4>
        <div id="design-recommendations">
          <!-- Design recommendations will be populated here -->
        </div>
      </div>
      
      <div class="card">
        <h4>Statistical Analysis</h4>
        <div id="statistical-analysis">
          <!-- Statistical analysis will be populated here -->
        </div>
      </div>
      
      <div class="card">
        <h4>Climate Analysis Summary</h4>
        <div id="climate-summary">
          <!-- Climate analysis summary will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
  </div>

  <script>
    // Global variables
    let weatherData = null;
    let currentParameter = 'Dry Bulb Temperature';
    let weatherChart = null;
    let histogramChart = null;
    let hddChart = null;
    let cddChart = null;
    let psychroChart = null;
    let currentUnits = 'SI'; // 'SI' or 'Imperial'
    let showComfortZone = true;
    let showHumidityLines = true;
    
    // Unit conversion functions
    const unitConversions = {
      temperature: {
        toImperial: (celsius) => celsius * 9/5 + 32,
        toSI: (fahrenheit) => (fahrenheit - 32) * 5/9
      },
      solarRadiation: {
        toImperial: (wm2) => wm2 * 0.316998, // W/m² to Btu/h·ft²
        toSI: (btuhft2) => btuhft2 / 0.316998
      },
      windSpeed: {
        toImperial: (ms) => ms * 2.237, // m/s to mph
        toSI: (mph) => mph / 2.237
      },
      pressure: {
        toImperial: (pa) => pa * 0.0002953, // Pa to inHg
        toSI: (inhg) => inhg / 0.0002953
      }
    };

    // Unit labels
    const unitLabels = {
      SI: {
        temperature: '°C',
        solarRadiation: 'W/m²',
        solarRadiationAnnual: 'kWh/m²',
        windSpeed: 'm/s',
        pressure: 'Pa'
      },
      Imperial: {
        temperature: '°F',
        solarRadiation: 'Btu/h·ft²',
        solarRadiationAnnual: 'kBtu/ft²',
        windSpeed: 'mph',
        pressure: 'inHg'
      }
    };

    // Load user preference from localStorage
    function loadUnitPreference() {
      const savedUnits = localStorage.getItem('epw-units');
      if (savedUnits && (savedUnits === 'SI' || savedUnits === 'Imperial')) {
        currentUnits = savedUnits;
        updateUnitToggleUI();
      }
    }

    // Save user preference to localStorage
    function saveUnitPreference() {
      localStorage.setItem('epw-units', currentUnits);
    }

    // Update unit toggle UI
    function updateUnitToggleUI() {
      const siButton = document.getElementById('siButton');
      const imperialButton = document.getElementById('imperialButton');
      
      if (currentUnits === 'SI') {
        siButton.classList.add('active');
        imperialButton.classList.remove('active');
      } else {
        siButton.classList.remove('active');
        imperialButton.classList.add('active');
      }
    }

    // Convert value based on parameter type and current units
    function convertValue(value, parameterType, fromUnits = null) {
      if (fromUnits === null) {
        fromUnits = currentUnits === 'SI' ? 'Imperial' : 'SI';
      }
      
      if (currentUnits === fromUnits) return value;
      
      const conversions = unitConversions[parameterType];
      if (!conversions) return value;
      
      if (currentUnits === 'Imperial') {
        return conversions.toImperial(value);
      } else {
        return conversions.toSI(value);
      }
    }

    // Format value with appropriate units
    function formatValueWithUnits(value, parameterType, precision = 1) {
      const labels = unitLabels[currentUnits];
      const unit = labels[parameterType] || '';
      return `${value.toFixed(precision)} ${unit}`;
    }

    // Update all unit labels in the interface
    function updateUnitLabels() {
      const labels = unitLabels[currentUnits];
      
      // Temperature labels
      document.getElementById('avg-temp-label').textContent = `Annual Average Temperature (${labels.temperature})`;
      document.getElementById('max-temp-label').textContent = `Maximum Temperature (${labels.temperature})`;
      document.getElementById('min-temp-label').textContent = `Minimum Temperature (${labels.temperature})`;
      document.getElementById('temp-range-label').textContent = `Annual Temperature Range (${labels.temperature})`;
      
      // Solar radiation labels
      document.getElementById('annual-solar-label').textContent = `Annual Solar Radiation (${labels.solarRadiationAnnual})`;
      document.getElementById('peak-solar-label').textContent = `Peak Solar Radiation (${labels.solarRadiation})`;
      
      // Wind speed labels
      document.getElementById('avg-wind-label').textContent = `Average Wind Speed (${labels.windSpeed})`;
      document.getElementById('max-wind-label').textContent = `Maximum Wind Speed (${labels.windSpeed})`;
      
      // HDD/CDD base temperature units
      document.getElementById('hdd-base-unit').textContent = labels.temperature;
      document.getElementById('cdd-base-unit').textContent = labels.temperature;
      
      // Monthly summary table headers
      document.getElementById('monthly-avg-temp-header').textContent = `Avg Temp (${labels.temperature})`;
      document.getElementById('monthly-solar-header').textContent = `Solar (${labels.solarRadiationAnnual})`;
      document.getElementById('monthly-wind-header').textContent = `Wind (${labels.windSpeed})`;
      
      // Extreme weather labels
      const extremeHeatTemp = currentUnits === 'SI' ? '35°C' : '95°F';
      const extremeColdTemp = currentUnits === 'SI' ? '0°C' : '32°F';
      document.getElementById('extreme-heat-label').textContent = `Days > ${extremeHeatTemp}`;
      document.getElementById('extreme-cold-label').textContent = `Days < ${extremeColdTemp}`;
    }

    // EPW parameter definitions with unit types
    const epwParameters = {
      'Dry Bulb Temperature': { index: 6, unit: 'temperature' },
      'Dew Point Temperature': { index: 7, unit: 'temperature' },
      'Relative Humidity': { index: 8, unit: null },
      'Atmospheric Station Pressure': { index: 9, unit: 'pressure' },
      'Extraterrestrial Horizontal Radiation': { index: 10, unit: 'solarRadiation' },
      'Extraterrestrial Direct Normal Radiation': { index: 11, unit: 'solarRadiation' },
      'Horizontal Infrared Radiation': { index: 12, unit: 'solarRadiation' },
      'Global Horizontal Radiation': { index: 13, unit: 'solarRadiation' },
      'Direct Normal Radiation': { index: 14, unit: 'solarRadiation' },
      'Diffuse Horizontal Radiation': { index: 15, unit: 'solarRadiation' },
      'Global Horizontal Illuminance': { index: 16, unit: null },
      'Direct Normal Illuminance': { index: 17, unit: null },
      'Diffuse Horizontal Illuminance': { index: 18, unit: null },
      'Zenith Luminance': { index: 19, unit: null },
      'Wind Direction': { index: 20, unit: null },
      'Wind Speed': { index: 21, unit: 'windSpeed' },
      'Total Sky Cover': { index: 22, unit: null },
      'Opaque Sky Cover': { index: 23, unit: null },
      'Visibility': { index: 24, unit: null },
      'Ceiling Height': { index: 25, unit: null },
      'Present Weather Observation': { index: 26, unit: null },
      'Present Weather Codes': { index: 27, unit: null },
      'Precipitable Water': { index: 28, unit: null },
      'Aerosol Optical Depth': { index: 29, unit: null },
      'Snow Depth': { index: 30, unit: null },
      'Days Since Last Snowfall': { index: 31, unit: null },
      'Albedo': { index: 32, unit: null },
      'Liquid Precipitation Depth': { index: 33, unit: null },
      'Liquid Precipitation Quantity': { index: 34, unit: null }
    };

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      loadUnitPreference();
      updateUnitLabels();
      setupEventListeners();
      populateParameterSelect();
    });

    function setupEventListeners() {
      // Unit toggle buttons
      document.getElementById('siButton').addEventListener('click', function() {
        if (currentUnits !== 'SI') {
          currentUnits = 'SI';
          saveUnitPreference();
          updateUnitToggleUI();
          updateUnitLabels();
          if (weatherData) {
            updateAllDisplays();
          }
        }
      });

      document.getElementById('imperialButton').addEventListener('click', function() {
        if (currentUnits !== 'Imperial') {
          currentUnits = 'Imperial';
          saveUnitPreference();
          updateUnitToggleUI();
          updateUnitLabels();
          if (weatherData) {
            updateAllDisplays();
          }
        }
      });

      // File upload
      const fileInput = document.getElementById('fileInput');
      const uploadSection = document.getElementById('uploadSection');

      fileInput.addEventListener('change', handleFileSelect);

      // Drag and drop
      uploadSection.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadSection.classList.add('dragover');
      });

      uploadSection.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadSection.classList.remove('dragover');
      });

      uploadSection.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadSection.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      });

      // Parameter selection
      document.getElementById('parameterSelect').addEventListener('change', function() {
        currentParameter = this.value;
        updateCharts();
      });

      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabName = this.dataset.tab;
          switchTab(tabName);
        });
      });

      // Chart controls
      document.getElementById('resetZoom').addEventListener('click', resetZoom);
      document.getElementById('toggleDaily').addEventListener('click', toggleDaily);
      document.getElementById('toggleMonthly').addEventListener('click', toggleMonthly);
      document.getElementById('toggleComfortZone').addEventListener('click', toggleComfortZone);
      document.getElementById('toggleHumidityLines').addEventListener('click', toggleHumidityLines);

      // Histogram controls
      const binCountSlider = document.getElementById('binCount');
      const binCountValue = document.getElementById('binCountValue');
      binCountSlider.addEventListener('input', function() {
        binCountValue.textContent = this.value;
        updateHistogram();
      });

      // HDD/CDD controls
      document.getElementById('hddBase').addEventListener('input', updateHDDCDD);
      document.getElementById('cddBase').addEventListener('input', updateHDDCDD);

      // Download buttons
      document.getElementById('downloadSelectedCSV').addEventListener('click', downloadSelectedCSV);
      document.getElementById('downloadAllCSV').addEventListener('click', downloadAllCSV);
      document.getElementById('downloadBinCSV').addEventListener('click', downloadBinCSV);
      document.getElementById('downloadReport').addEventListener('click', downloadReport);
    }

    function populateParameterSelect() {
      const select = document.getElementById('parameterSelect');
      select.innerHTML = '';
      
      Object.keys(epwParameters).forEach(param => {
        const option = document.createElement('option');
        option.value = param;
        option.textContent = param;
        select.appendChild(option);
      });
      
      select.value = currentParameter;
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        handleFile(file);
      }
    }

    function handleFile(file) {
      if (!file.name.toLowerCase().endsWith('.epw')) {
        alert('Please select a valid EPW file.');
        return;
      }

      showLoading();
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          parseEPWFile(e.target.result, file.name);
        } catch (error) {
          alert('Error parsing EPW file: ' + error.message);
          hideLoading();
        }
      };
      reader.readAsText(file);
    }

    function parseEPWFile(content, filename) {
      const lines = content.split('\n');
      
      // Parse header information
      const locationLine = lines[0].split(',');
      const location = {
        city: locationLine[1],
        state: locationLine[2],
        country: locationLine[3],
        latitude: parseFloat(locationLine[6]),
        longitude: parseFloat(locationLine[7]),
        timezone: parseFloat(locationLine[8]),
        elevation: parseFloat(locationLine[9])
      };

      // Parse weather data (skip header lines)
      const dataLines = lines.slice(8).filter(line => line.trim() && line.split(',').length > 30);
      
      const data = dataLines.map(line => {
        const values = line.split(',');
        return {
          month: parseInt(values[1]),
          day: parseInt(values[2]),
          hour: parseInt(values[3]),
          minute: parseInt(values[4]),
          dryBulbTemp: parseFloat(values[6]) || 0,
          dewPointTemp: parseFloat(values[7]) || 0,
          relativeHumidity: parseFloat(values[8]) || 0,
          atmosphericPressure: parseFloat(values[9]) || 0,
          extraterrestrialHorizontalRadiation: parseFloat(values[10]) || 0,
          extraterrestrialDirectNormalRadiation: parseFloat(values[11]) || 0,
          horizontalInfraredRadiation: parseFloat(values[12]) || 0,
          globalHorizontalRadiation: parseFloat(values[13]) || 0,
          directNormalRadiation: parseFloat(values[14]) || 0,
          diffuseHorizontalRadiation: parseFloat(values[15]) || 0,
          globalHorizontalIlluminance: parseFloat(values[16]) || 0,
          directNormalIlluminance: parseFloat(values[17]) || 0,
          diffuseHorizontalIlluminance: parseFloat(values[18]) || 0,
          zenithLuminance: parseFloat(values[19]) || 0,
          windDirection: parseFloat(values[20]) || 0,
          windSpeed: parseFloat(values[21]) || 0,
          totalSkyCover: parseFloat(values[22]) || 0,
          opaqueSkyCover: parseFloat(values[23]) || 0,
          visibility: parseFloat(values[24]) || 0,
          ceilingHeight: parseFloat(values[25]) || 0,
          presentWeatherObservation: parseInt(values[26]) || 0,
          presentWeatherCodes: parseInt(values[27]) || 0,
          precipitableWater: parseFloat(values[28]) || 0,
          aerosolOpticalDepth: parseFloat(values[29]) || 0,
          snowDepth: parseFloat(values[30]) || 0,
          daysSinceLastSnowfall: parseFloat(values[31]) || 0,
          albedo: parseFloat(values[32]) || 0,
          liquidPrecipitationDepth: parseFloat(values[33]) || 0,
          liquidPrecipitationQuantity: parseFloat(values[34]) || 0
        };
      });

      weatherData = {
        location: location,
        data: data,
        filename: filename
      };

      // Update UI
      document.getElementById('weatherFileInfo').textContent = 
        `Weather File: ${filename} - ${location.city}, ${location.state}, ${location.country}`;
      
      // Enable controls
      document.getElementById('parameterSelect').disabled = false;
      document.getElementById('downloadSelectedCSV').disabled = false;
      document.getElementById('downloadAllCSV').disabled = false;
      document.getElementById('downloadBinCSV').disabled = false;
      document.getElementById('downloadReport').disabled = false;

      updateAllDisplays();
      hideLoading();
    }

    function updateAllDisplays() {
      updateCharts();
      updateClimateAnalysis();
      updateHDDCDD();
      updateAdvancedMetrics();
      updatePsychrometricChart();
    }

    function updateCharts() {
      if (!weatherData) return;
      
      updateTimeSeriesChart();
      updateHistogram();
    }

    function updateTimeSeriesChart() {
      const ctx = document.getElementById('weatherChart').getContext('2d');
      
      if (weatherChart) {
        weatherChart.destroy();
      }

      const paramInfo = epwParameters[currentParameter];
      if (!paramInfo) return;

      // Create monthly aggregate data for cleaner display
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                         'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      // Create hourly labels with proper month markers
      const labels = [];
      const rawData = getParameterData(currentParameter);
      const data = [];
      
      weatherData.data.forEach((d, i) => {
        // Create date and time string for each hour
        const dateStr = `${monthNames[d.month - 1]} ${d.day} ${d.hour}:00`;
        labels.push(dateStr);
        
        let value = rawData[i];
        if (paramInfo.unit) {
          value = convertValue(value, paramInfo.unit, 'SI');
        }
        data.push(value);
      });

      const unitLabel = paramInfo.unit ? unitLabels[currentUnits][paramInfo.unit] : '';

      weatherChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: `${currentParameter} ${unitLabel}`,
            data: data,
            borderColor: 'rgb(37, 99, 235)',
            backgroundColor: 'rgba(37, 99, 235, 0.1)',
            borderWidth: 1,
            pointRadius: 0,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: {
                display: true,
                text: 'Time (Months)'
              },
              ticks: {
                maxTicksLimit: 12,
                callback: function(value, index, values) {
                  const label = this.getLabelForValue(value);
                  // Only show first day of each month to avoid overcrowding
                  if (label && (label.includes(' 1') || index % Math.floor(values.length / 12) === 0)) {
                    return label.split(' ')[0]; // Just show month name
                  }
                  return '';
                }
              }
            },
            y: {
              title: {
                display: true,
                text: `${currentParameter} (${unitLabel})`
              }
            }
          },
          plugins: {
            zoom: {
              zoom: {
                wheel: {
                  enabled: true,
                },
                pinch: {
                  enabled: true
                },
                mode: 'x',
              },
              pan: {
                enabled: true,
                mode: 'x',
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${currentParameter}: ${context.parsed.y.toFixed(2)} ${unitLabel}`;
                }
              }
            }
          }
        }
      });
    }

    function updateHistogram() {
      const ctx = document.getElementById('histogramChart').getContext('2d');
      
      if (histogramChart) {
        histogramChart.destroy();
      }

      const paramInfo = epwParameters[currentParameter];
      if (!paramInfo) return;

      let data = getParameterData(currentParameter);
      
      // Convert units if necessary
      if (paramInfo.unit) {
        data = data.map(value => convertValue(value, paramInfo.unit, 'SI'));
      }

      const binCount = parseInt(document.getElementById('binCount').value);
      const min = Math.min(...data);
      const max = Math.max(...data);
      const binSize = (max - min) / binCount;
      
      const bins = new Array(binCount).fill(0);
      const binLabels = [];
      
      for (let i = 0; i < binCount; i++) {
        const binStart = min + i * binSize;
        const binEnd = min + (i + 1) * binSize;
        binLabels.push(`${binStart.toFixed(1)}-${binEnd.toFixed(1)}`);
      }
      
      data.forEach(value => {
        const binIndex = Math.min(Math.floor((value - min) / binSize), binCount - 1);
        bins[binIndex]++;
      });

      const unitLabel = paramInfo.unit ? unitLabels[currentUnits][paramInfo.unit] : '';

      histogramChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: binLabels,
          datasets: [{
            label: 'Frequency',
            data: bins,
            backgroundColor: 'rgba(37, 99, 235, 0.6)',
            borderColor: 'rgb(37, 99, 235)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: {
                display: true,
                text: `${currentParameter} (${unitLabel})`
              }
            },
            y: {
              title: {
                display: true,
                text: 'Frequency'
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Frequency: ${context.parsed.y}`;
                }
              }
            }
          }
        }
      });
    }

    function updatePsychrometricChart() {
      if (!weatherData) return;

      const dryBulbData = getParameterData('Dry Bulb Temperature');
      const relativeHumidityData = getParameterData('Relative Humidity');
      
      // Convert temperature to current units
      const temperatures = dryBulbData.map(temp => 
        convertValue(temp, 'temperature', 'SI')
      );
      
      // Calculate absolute humidity from relative humidity and temperature
      const absoluteHumidity = temperatures.map((temp, i) => {
        const rh = relativeHumidityData[i];
        // Convert back to Celsius for calculation if needed
        const tempC = currentUnits === 'Imperial' ? convertValue(temp, 'temperature', 'Imperial') : temp;
        return calculateAbsoluteHumidity(tempC, rh);
      });

      const trace = {
        x: temperatures,
        y: absoluteHumidity,
        mode: 'markers',
        type: 'scatter',
        marker: {
          size: 3,
          color: relativeHumidityData,
          colorscale: 'Viridis',
          colorbar: {
            title: 'Relative Humidity (%)'
          }
        },
        name: 'Weather Data'
      };

      const traces = [trace];

      // Add comfort zone if enabled
      if (showComfortZone) {
        const comfortZone = getComfortZone();
        traces.push(comfortZone);
      }

      // Add humidity lines if enabled
      if (showHumidityLines) {
        const humidityLines = getHumidityLines();
        traces.push(...humidityLines);
      }

      const tempUnit = unitLabels[currentUnits].temperature;
      
      const layout = {
        title: 'Psychrometric Chart',
        xaxis: {
          title: `Dry Bulb Temperature (${tempUnit})`,
          range: [Math.min(...temperatures) - 2, Math.max(...temperatures) + 2]
        },
        yaxis: {
          title: 'Absolute Humidity (g/kg)',
          range: [0, Math.max(...absoluteHumidity) + 2]
        },
        showlegend: true
      };

      Plotly.newPlot('chart', traces, layout);
    }

    function calculateAbsoluteHumidity(tempC, relativeHumidity) {
      // Calculate saturation vapor pressure using Magnus formula
      const saturationVaporPressure = 6.112 * Math.exp((17.67 * tempC) / (tempC + 243.5));
      
      // Calculate actual vapor pressure
      const actualVaporPressure = (relativeHumidity / 100) * saturationVaporPressure;
      
      // Calculate absolute humidity (g/kg)
      const absoluteHumidity = (621.97 * actualVaporPressure) / (1013.25 - actualVaporPressure);
      
      return Math.max(0, absoluteHumidity);
    }

    function getComfortZone() {
      // Define comfort zone boundaries based on ASHRAE Standard 55
      const comfortTempMin = currentUnits === 'SI' ? 20 : 68;
      const comfortTempMax = currentUnits === 'SI' ? 26 : 79;
      const comfortHumidityMin = 30;
      const comfortHumidityMax = 70;
      
      // Convert humidity limits to absolute humidity at comfort temperatures
      const tempC_min = currentUnits === 'SI' ? comfortTempMin : convertValue(comfortTempMin, 'temperature', 'Imperial');
      const tempC_max = currentUnits === 'SI' ? comfortTempMax : convertValue(comfortTempMax, 'temperature', 'Imperial');
      
      const ahMin_min = calculateAbsoluteHumidity(tempC_min, comfortHumidityMin);
      const ahMax_min = calculateAbsoluteHumidity(tempC_min, comfortHumidityMax);
      const ahMin_max = calculateAbsoluteHumidity(tempC_max, comfortHumidityMin);
      const ahMax_max = calculateAbsoluteHumidity(tempC_max, comfortHumidityMax);
      
      return {
        x: [comfortTempMin, comfortTempMax, comfortTempMax, comfortTempMin, comfortTempMin],
        y: [ahMin_min, ahMin_max, ahMax_max, ahMax_min, ahMin_min],
        fill: 'toself',
        fillcolor: 'rgba(0, 255, 0, 0.1)',
        line: { color: 'green', width: 2 },
        mode: 'lines',
        name: 'Comfort Zone',
        type: 'scatter'
      };
    }

    function getHumidityLines() {
      const lines = [];
      const tempRange = currentUnits === 'SI' ? 
        { min: -10, max: 50 } : 
        { min: 14, max: 122 };
      
      const rhLevels = [20, 40, 60, 80, 100];
      
      rhLevels.forEach(rh => {
        const temps = [];
        const humidities = [];
        
        for (let temp = tempRange.min; temp <= tempRange.max; temp += 2) {
          const tempC = currentUnits === 'SI' ? temp : convertValue(temp, 'temperature', 'Imperial');
          const ah = calculateAbsoluteHumidity(tempC, rh);
          temps.push(temp);
          humidities.push(ah);
        }
        
        lines.push({
          x: temps,
          y: humidities,
          mode: 'lines',
          line: { color: 'rgba(0, 0, 255, 0.3)', width: 1 },
          name: `${rh}% RH`,
          type: 'scatter'
        });
      });
      
      return lines;
    }

    function updateClimateAnalysis() {
      if (!weatherData) return;

      const dryBulbData = getParameterData('Dry Bulb Temperature');
      const relativeHumidityData = getParameterData('Relative Humidity');
      const globalHorizontalRadiation = getParameterData('Global Horizontal Radiation');
      const windSpeedData = getParameterData('Wind Speed');
      const windDirectionData = getParameterData('Wind Direction');

      // Convert temperature data
      const temperatures = dryBulbData.map(temp => convertValue(temp, 'temperature', 'SI'));
      const windSpeeds = windSpeedData.map(speed => convertValue(speed, 'windSpeed', 'SI'));
      const solarRadiation = globalHorizontalRadiation.map(rad => convertValue(rad, 'solarRadiation', 'SI'));

      // Temperature statistics
      const avgTemp = temperatures.reduce((a, b) => a + b, 0) / temperatures.length;
      const maxTemp = Math.max(...temperatures);
      const minTemp = Math.min(...temperatures);
      const tempRange = maxTemp - minTemp;

      document.getElementById('avg-temp').textContent = formatValueWithUnits(avgTemp, 'temperature');
      document.getElementById('max-temp').textContent = formatValueWithUnits(maxTemp, 'temperature');
      document.getElementById('min-temp').textContent = formatValueWithUnits(minTemp, 'temperature');
      document.getElementById('temp-range').textContent = formatValueWithUnits(tempRange, 'temperature');

      // Humidity statistics
      const avgRH = relativeHumidityData.reduce((a, b) => a + b, 0) / relativeHumidityData.length;
      const highHumidityHours = relativeHumidityData.filter(rh => rh > 70).length;
      const lowHumidityHours = relativeHumidityData.filter(rh => rh < 30).length;

      document.getElementById('avg-rh').textContent = `${avgRH.toFixed(1)}%`;
      document.getElementById('high-humidity-hours').textContent = highHumidityHours;
      document.getElementById('low-humidity-hours').textContent = lowHumidityHours;

      // Solar radiation statistics
      const annualSolar = solarRadiation.reduce((a, b) => a + b, 0) / 1000; // Convert to kWh/m² or kBtu/ft²
      const peakSolar = Math.max(...solarRadiation);
      const solarThreshold = currentUnits === 'SI' ? 100 : 31.7; // 100 W/m² = ~31.7 Btu/h·ft²
      const solarHours = solarRadiation.filter(rad => rad > solarThreshold).length;

      const solarAnnualUnit = currentUnits === 'SI' ? 'kWh/m²' : 'kBtu/ft²';
      const annualSolarConverted = currentUnits === 'SI' ? annualSolar : annualSolar * 0.316998;
      
      document.getElementById('annual-solar').textContent = formatValueWithUnits(annualSolarConverted, 'solarRadiationAnnual');
      document.getElementById('peak-solar').textContent = formatValueWithUnits(peakSolar, 'solarRadiation');
      document.getElementById('solar-hours').textContent = solarHours;

      // Wind statistics
      const avgWind = windSpeeds.reduce((a, b) => a + b, 0) / windSpeeds.length;
      const maxWind = Math.max(...windSpeeds);
      const prevailingWind = calculatePrevailingWindDirection(windDirectionData);

      document.getElementById('avg-wind').textContent = formatValueWithUnits(avgWind, 'windSpeed');
      document.getElementById('max-wind').textContent = formatValueWithUnits(maxWind, 'windSpeed');
      document.getElementById('prevailing-wind').textContent = prevailingWind;

      // Climate zone analysis
      updateClimateZone(avgTemp, tempRange, relativeHumidityData);
    }

    function calculatePrevailingWindDirection(windDirections) {
      const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 
                         'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
      const bins = new Array(16).fill(0);
      
      windDirections.forEach(dir => {
        const binIndex = Math.round(dir / 22.5) % 16;
        bins[binIndex]++;
      });
      
      const maxIndex = bins.indexOf(Math.max(...bins));
      return directions[maxIndex];
    }

    function updateClimateZone(avgTemp, tempRange, relativeHumidityData) {
      // Convert to Celsius for climate zone calculation
      const avgTempC = currentUnits === 'SI' ? avgTemp : convertValue(avgTemp, 'temperature', 'Imperial');
      const tempRangeC = currentUnits === 'SI' ? tempRange : tempRange * 5/9; // Range conversion is different
      const avgRH = relativeHumidityData.reduce((a, b) => a + b, 0) / relativeHumidityData.length;
      
      // Use the original correct climate zone determination
      let zone = 'Unknown';
      let description = 'Climate zone could not be determined.';
      
      if (avgTempC >= 18) {
        if (tempRangeC < 20) {
          zone = '1A - Very Hot Humid';
          description = 'Very hot and humid climate with minimal temperature variation.';
        } else {
          zone = '2A - Hot Humid';
          description = 'Hot and humid climate with moderate temperature variation.';
        }
      } else if (avgTempC >= 13) {
        zone = '3A - Warm Humid';
        description = 'Warm climate with significant humidity levels.';
      } else if (avgTempC >= 10) {
        zone = '4A - Mixed Humid';
        description = 'Mixed climate requiring both heating and cooling.';
      } else if (avgTempC >= 7) {
        zone = '5A - Cool Humid';
        description = 'Cool climate with heating dominant but some cooling required.';
      } else {
        zone = '6A - Cold Humid';
        description = 'Cold climate with heating dominant year-round.';
      }
      
      document.getElementById('ashrae-zone').textContent = `ASHRAE Climate Zone: ${zone}`;
      document.getElementById('zone-description').textContent = description;
      
      // Add climate badges
      const badgesContainer = document.getElementById('climate-badges');
      badgesContainer.innerHTML = '';
      
      const badges = [];
      if (avgTempC > 20) badges.push({ text: 'Hot', class: 'badge-danger' });
      else if (avgTempC > 15) badges.push({ text: 'Warm', class: 'badge-warning' });
      else if (avgTempC > 5) badges.push({ text: 'Cool', class: 'badge-primary' });
      else badges.push({ text: 'Cold', class: 'badge-secondary' });
      
      if (avgRH > 70) badges.push({ text: 'High Humidity', class: 'badge-accent' });
      else if (avgRH > 50) badges.push({ text: 'Moderate Humidity', class: 'badge-primary' });
      else badges.push({ text: 'Low Humidity', class: 'badge-success' });
      
      if (tempRangeC > 30) badges.push({ text: 'High Variation', class: 'badge-warning' });
      else if (tempRangeC > 20) badges.push({ text: 'Moderate Variation', class: 'badge-secondary' });
      else badges.push({ text: 'Low Variation', class: 'badge-success' });
      
      badges.forEach(badge => {
        const span = document.createElement('span');
        span.className = `badge ${badge.class}`;
        span.textContent = badge.text;
        badgesContainer.appendChild(span);
      });
    }

    function updateHDDCDD() {
      if (!weatherData) return;

      const dryBulbData = getParameterData('Dry Bulb Temperature');
      const temperatures = dryBulbData.map(temp => convertValue(temp, 'temperature', 'SI'));
      
      // Get base temperatures (convert to SI for calculation if needed)
      let hddBase = parseFloat(document.getElementById('hddBase').value);
      let cddBase = parseFloat(document.getElementById('cddBase').value);
      
      if (currentUnits === 'Imperial') {
        hddBase = convertValue(hddBase, 'temperature', 'Imperial');
        cddBase = convertValue(cddBase, 'temperature', 'Imperial');
      }

      // Calculate daily average temperatures
      const dailyTemps = [];
      for (let day = 0; day < 365; day++) {
        const dayTemps = temperatures.slice(day * 24, (day + 1) * 24);
        const avgTemp = dayTemps.reduce((a, b) => a + b, 0) / dayTemps.length;
        dailyTemps.push(avgTemp);
      }

      // Calculate HDD and CDD
      const hddDaily = dailyTemps.map(temp => Math.max(0, hddBase - temp));
      const cddDaily = dailyTemps.map(temp => Math.max(0, temp - cddBase));
      
      const annualHDD = hddDaily.reduce((a, b) => a + b, 0);
      const annualCDD = cddDaily.reduce((a, b) => a + b, 0);

      // Calculate monthly HDD/CDD
      const monthlyHDD = new Array(12).fill(0);
      const monthlyCDD = new Array(12).fill(0);
      const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
      
      let dayIndex = 0;
      for (let month = 0; month < 12; month++) {
        for (let day = 0; day < daysInMonth[month]; day++) {
          monthlyHDD[month] += hddDaily[dayIndex];
          monthlyCDD[month] += cddDaily[dayIndex];
          dayIndex++;
        }
      }

      const maxMonthlyHDD = Math.max(...monthlyHDD);
      const maxMonthlyCDD = Math.max(...monthlyCDD);

      // Update display
      const tempUnit = unitLabels[currentUnits].temperature;
      document.getElementById('annual-hdd').textContent = annualHDD.toFixed(0);
      document.getElementById('annual-cdd').textContent = annualCDD.toFixed(0);
      document.getElementById('monthly-hdd-max').textContent = maxMonthlyHDD.toFixed(0);
      document.getElementById('monthly-cdd-max').textContent = maxMonthlyCDD.toFixed(0);
      
      document.getElementById('annual-hdd-label').textContent = `Annual HDD (base ${formatValueWithUnits(currentUnits === 'SI' ? hddBase : convertValue(hddBase, 'temperature', 'SI'), 'temperature')})`;
      document.getElementById('annual-cdd-label').textContent = `Annual CDD (base ${formatValueWithUnits(currentUnits === 'SI' ? cddBase : convertValue(cddBase, 'temperature', 'SI'), 'temperature')})`;

      // Update charts
      updateHDDChart(monthlyHDD);
      updateCDDChart(monthlyCDD);
    }

    function updateHDDChart(monthlyHDD) {
      const ctx = document.getElementById('hddChart').getContext('2d');
      
      if (hddChart) {
        hddChart.destroy();
      }

      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                     'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

      hddChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'Monthly HDD',
            data: monthlyHDD,
            backgroundColor: 'rgba(59, 130, 246, 0.6)',
            borderColor: 'rgb(59, 130, 246)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Heating Degree Days'
              }
            }
          }
        }
      });
    }

    function updateCDDChart(monthlyCDD) {
      const ctx = document.getElementById('cddChart').getContext('2d');
      
      if (cddChart) {
        cddChart.destroy();
      }

      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                     'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

      cddChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'Monthly CDD',
            data: monthlyCDD,
            backgroundColor: 'rgba(220, 38, 38, 0.6)',
            borderColor: 'rgb(220, 38, 38)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Cooling Degree Days'
              }
            }
          }
        }
      });
    }

    function updateAdvancedMetrics() {
      if (!weatherData) return;

      const dryBulbData = getParameterData('Dry Bulb Temperature');
      const relativeHumidityData = getParameterData('Relative Humidity');
      const precipitationData = getParameterData('Liquid Precipitation Depth');
      
      const temperatures = dryBulbData.map(temp => convertValue(temp, 'temperature', 'SI'));
      
      // Thermal comfort analysis (simplified)
      const comfortMin = currentUnits === 'SI' ? 20 : 68;
      const comfortMax = currentUnits === 'SI' ? 26 : 79;
      
      const comfortHours = temperatures.filter(temp => temp >= comfortMin && temp <= comfortMax).length;
      const overheatingHours = temperatures.filter(temp => temp > comfortMax).length;
      const underheatingHours = temperatures.filter(temp => temp < comfortMin).length;

      // Extreme weather events
      const extremeHeatThreshold = currentUnits === 'SI' ? 35 : 95;
      const extremeColdThreshold = currentUnits === 'SI' ? 0 : 32;
      
      // Calculate daily max temperatures for extreme day counts
      const dailyMaxTemps = [];
      for (let day = 0; day < 365; day++) {
        const dayTemps = temperatures.slice(day * 24, (day + 1) * 24);
        const maxTemp = Math.max(...dayTemps);
        dailyMaxTemps.push(maxTemp);
      }
      
      const extremeHeatDays = dailyMaxTemps.filter(temp => temp > extremeHeatThreshold).length;
      const extremeColdDays = dailyMaxTemps.filter(temp => temp < extremeColdThreshold).length;
      const precipitationDays = precipitationData.filter(precip => precip > 0).length / 24; // Convert hours to days

      // Update display
      document.getElementById('comfort-hours').textContent = comfortHours;
      document.getElementById('overheating-hours').textContent = overheatingHours;
      document.getElementById('underheating-hours').textContent = underheatingHours;
      document.getElementById('extreme-heat-days').textContent = extremeHeatDays;
      document.getElementById('extreme-cold-days').textContent = extremeColdDays;
      document.getElementById('precipitation-days').textContent = Math.round(precipitationDays);

      // Update monthly summary table
      updateMonthlySummary();
      
      // Update design recommendations, statistical analysis, and climate summary
      updateDesignRecommendations();
      updateStatisticalAnalysis();
      updateClimateSummary();
    }

    function updateMonthlySummary() {
      const tbody = document.getElementById('monthly-summary-body');
      tbody.innerHTML = '';
      
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                     'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
      
      const dryBulbData = getParameterData('Dry Bulb Temperature');
      const globalHorizontalRadiation = getParameterData('Global Horizontal Radiation');
      const relativeHumidityData = getParameterData('Relative Humidity');
      const windSpeedData = getParameterData('Wind Speed');
      
      // Convert data to current units
      const temperatures = dryBulbData.map(temp => convertValue(temp, 'temperature', 'SI'));
      const solarRadiation = globalHorizontalRadiation.map(rad => convertValue(rad, 'solarRadiation', 'SI'));
      const windSpeeds = windSpeedData.map(speed => convertValue(speed, 'windSpeed', 'SI'));
      
      let hourIndex = 0;
      for (let month = 0; month < 12; month++) {
        const hoursInMonth = daysInMonth[month] * 24;
        
        // Extract data for this month
        const monthTemps = temperatures.slice(hourIndex, hourIndex + hoursInMonth);
        const monthSolar = solarRadiation.slice(hourIndex, hourIndex + hoursInMonth);
        const monthHumidity = relativeHumidityData.slice(hourIndex, hourIndex + hoursInMonth);
        const monthWind = windSpeeds.slice(hourIndex, hourIndex + hoursInMonth);
        
        // Calculate averages
        const avgTemp = monthTemps.reduce((a, b) => a + b, 0) / monthTemps.length;
        const avgSolar = (monthSolar.reduce((a, b) => a + b, 0) / 1000) * hoursInMonth / 1000; // Convert to kWh/m² or kBtu/ft²
        const avgHumidity = monthHumidity.reduce((a, b) => a + b, 0) / monthHumidity.length;
        const avgWind = monthWind.reduce((a, b) => a + b, 0) / monthWind.length;
        
        // Convert solar radiation for annual units
        const avgSolarConverted = currentUnits === 'SI' ? avgSolar : avgSolar * 0.316998;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${months[month]}</td>
          <td>${formatValueWithUnits(avgTemp, 'temperature')}</td>
          <td>${formatValueWithUnits(avgSolarConverted, 'solarRadiationAnnual')}</td>
          <td>${avgHumidity.toFixed(1)}%</td>
          <td>${formatValueWithUnits(avgWind, 'windSpeed')}</td>
        `;
        tbody.appendChild(row);
        
        hourIndex += hoursInMonth;
      }
    }

    function updateDesignRecommendations() {
      if (!weatherData) return;
      
      const container = document.getElementById('design-recommendations');
      const dryBulbData = getParameterData('Dry Bulb Temperature');
      const relativeHumidityData = getParameterData('Relative Humidity');
      const globalHorizontalRadiation = getParameterData('Global Horizontal Radiation');
      const windSpeedData = getParameterData('Wind Speed');
      
      const temperatures = dryBulbData.map(temp => convertValue(temp, 'temperature', 'SI'));
      const avgTemp = temperatures.reduce((a, b) => a + b, 0) / temperatures.length;
      const avgRH = relativeHumidityData.reduce((a, b) => a + b, 0) / relativeHumidityData.length;
      const avgSolar = globalHorizontalRadiation.reduce((a, b) => a + b, 0) / globalHorizontalRadiation.length;
      const avgWind = windSpeedData.reduce((a, b) => a + b, 0) / windSpeedData.length;
      
      // Generate design recommendations based on climate data
      const recommendations = [];
      
      // Climate zone determination for context
      const tempRangeC = Math.max(...temperatures) - Math.min(...temperatures);
      const climateZone = determineClimateZone(avgTemp, 0, 0, avgRH);
      
      // Building envelope recommendations
      if (avgTemp > 25) {
        recommendations.push({
          category: 'Building Envelope',
          priority: 'High',
          title: 'Enhanced Insulation & Thermal Mass',
          description: 'Use high R-value insulation (R-30+ walls, R-49+ roof) and thermal mass materials to reduce cooling loads in this hot climate.'
        });
      } else if (avgTemp < 10) {
        recommendations.push({
          category: 'Building Envelope',
          priority: 'High',
          title: 'Superior Insulation & Air Sealing',
          description: 'Implement continuous insulation (R-40+ walls, R-60+ roof) and rigorous air sealing to minimize heating loads.'
        });
      }
      
      // HVAC recommendations
      if (avgRH > 70) {
        recommendations.push({
          category: 'HVAC Systems',
          priority: 'High',
          title: 'Dehumidification Systems',
          description: 'Install dedicated outdoor air systems (DOAS) with dehumidification capabilities to manage high humidity levels effectively.'
        });
      } else if (avgRH < 30) {
        recommendations.push({
          category: 'HVAC Systems',
          priority: 'Medium',
          title: 'Humidification Systems',
          description: 'Consider humidification systems during dry periods to maintain occupant comfort and prevent static electricity issues.'
        });
      }
      
      // Solar and renewable energy
      if (avgSolar > 400) {
        recommendations.push({
          category: 'Renewable Energy',
          priority: 'High',
          title: 'Solar PV Integration',
          description: 'Excellent solar resource available. Consider rooftop or ground-mounted PV systems with battery storage for energy independence.'
        });
      }
      
      // Natural ventilation
      if (avgWind > 3 && avgTemp < 25) {
        recommendations.push({
          category: 'Natural Ventilation',
          priority: 'Medium',
          title: 'Wind-Driven Ventilation',
          description: 'Favorable wind conditions support natural ventilation strategies. Design operable windows and stack ventilation systems.'
        });
      }
      
      // Water management
      const precipitationData = getParameterData('Liquid Precipitation Depth');
      const annualPrecip = precipitationData.reduce((a, b) => a + b, 0);
      
      if (annualPrecip > 1000) {
        recommendations.push({
          category: 'Water Management',
          priority: 'High',
          title: 'Stormwater Management',
          description: 'High precipitation levels require robust drainage systems, green roofs, and permeable paving to manage runoff.'
        });
      } else if (annualPrecip < 300) {
        recommendations.push({
          category: 'Water Management',
          priority: 'High',
          title: 'Water Conservation',
          description: 'Low precipitation requires water conservation measures: rainwater harvesting, xeriscaping, and efficient irrigation systems.'
        });
      }
      
      // Daylighting
      recommendations.push({
        category: 'Daylighting',
        priority: 'Medium',
        title: 'Optimized Daylight Design',
        description: 'Design south-facing windows with appropriate overhangs. Use high-performance glazing and consider automated shading systems.'
      });
      
      // Render recommendations
      let html = '<div class="recommendations-grid">';
      recommendations.forEach(rec => {
        const priorityClass = rec.priority.toLowerCase();
        html += `
          <div class="recommendation-card priority-${priorityClass}">
            <div class="rec-header">
              <span class="rec-category">${rec.category}</span>
              <span class="rec-priority priority-${priorityClass}">${rec.priority}</span>
            </div>
            <h5>${rec.title}</h5>
            <p>${rec.description}</p>
          </div>
        `;
      });
      html += '</div>';
      
      container.innerHTML = html;
    }

    function updateStatisticalAnalysis() {
      if (!weatherData) return;
      
      const container = document.getElementById('statistical-analysis');
      const dryBulbData = getParameterData('Dry Bulb Temperature');
      const relativeHumidityData = getParameterData('Relative Humidity');
      const globalHorizontalRadiation = getParameterData('Global Horizontal Radiation');
      const windSpeedData = getParameterData('Wind Speed');
      
      const temperatures = dryBulbData.map(temp => convertValue(temp, 'temperature', 'SI'));
      const humidity = relativeHumidityData;
      const solar = globalHorizontalRadiation.map(rad => convertValue(rad, 'solarRadiation', 'SI'));
      const wind = windSpeedData.map(speed => convertValue(speed, 'windSpeed', 'SI'));
      
      // Calculate basic statistics
      function calculateStats(data) {
        const sorted = [...data].sort((a, b) => a - b);
        const mean = data.reduce((a, b) => a + b, 0) / data.length;
        const variance = data.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / data.length;
        const stdDev = Math.sqrt(variance);
        const median = sorted[Math.floor(sorted.length / 2)];
        const q1 = sorted[Math.floor(sorted.length * 0.25)];
        const q3 = sorted[Math.floor(sorted.length * 0.75)];
        const min = Math.min(...data);
        const max = Math.max(...data);
        const range = max - min;
        
        return { mean, median, stdDev, min, max, range, q1, q3, variance };
      }
      
      // Calculate correlation between temperature and humidity
      function calculateCorrelation(x, y) {
        const n = x.length;
        const sumX = x.reduce((a, b) => a + b, 0);
        const sumY = y.reduce((a, b) => a + b, 0);
        const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
        const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
        const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
        
        const numerator = n * sumXY - sumX * sumY;
        const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
        
        return denominator === 0 ? 0 : numerator / denominator;
      }
      
      // Calculate linear regression (temperature vs solar radiation)
      function calculateRegression(x, y) {
        const n = x.length;
        const sumX = x.reduce((a, b) => a + b, 0);
        const sumY = y.reduce((a, b) => a + b, 0);
        const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
        const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
        
        const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        
        // Calculate R-squared
        const meanY = sumY / n;
        const totalSumSquares = y.reduce((sum, yi) => sum + Math.pow(yi - meanY, 2), 0);
        const residualSumSquares = y.reduce((sum, yi, i) => {
          const predicted = slope * x[i] + intercept;
          return sum + Math.pow(yi - predicted, 2);
        }, 0);
        const rSquared = 1 - (residualSumSquares / totalSumSquares);
        
        return { slope, intercept, rSquared };
      }
      
      const tempStats = calculateStats(temperatures);
      const humidityStats = calculateStats(humidity);
      const solarStats = calculateStats(solar);
      const windStats = calculateStats(wind);
      
      // Climate science correlations
      const tempHumidityCorr = calculateCorrelation(temperatures, humidity);
      const tempSolarCorr = calculateCorrelation(temperatures, solar);
      const solarWindCorr = calculateCorrelation(solar, wind);
      const humidityWindCorr = calculateCorrelation(humidity, wind);
      
      // Climate-relevant regressions
      const solarTempRegression = calculateRegression(solar, temperatures);
      const tempHumidityRegression = calculateRegression(temperatures, humidity);
      
      // Seasonal analysis
      const seasonalData = { winter: [], spring: [], summer: [], autumn: [] };
      temperatures.forEach((temp, i) => {
        const month = weatherData.data[i].month;
        if (month === 12 || month <= 2) seasonalData.winter.push(temp);
        else if (month >= 3 && month <= 5) seasonalData.spring.push(temp);
        else if (month >= 6 && month <= 8) seasonalData.summer.push(temp);
        else seasonalData.autumn.push(temp);
      });
      
      const seasonalStats = {
        winter: calculateStats(seasonalData.winter),
        spring: calculateStats(seasonalData.spring),
        summer: calculateStats(seasonalData.summer),
        autumn: calculateStats(seasonalData.autumn)
      };
      
      const html = `
        <div class="stats-analysis-grid">
          <div class="analysis-section">
            <h5>Temperature Statistics</h5>
            <div class="stat-grid">
              <div class="stat-item">
                <strong>Mean:</strong> ${formatValueWithUnits(tempStats.mean, 'temperature')}
              </div>
              <div class="stat-item">
                <strong>Std Dev:</strong> ${formatValueWithUnits(tempStats.stdDev, 'temperature')}
              </div>
              <div class="stat-item">
                <strong>Range:</strong> ${formatValueWithUnits(tempStats.range, 'temperature')}
              </div>
              <div class="stat-item">
                <strong>Median:</strong> ${formatValueWithUnits(tempStats.median, 'temperature')}
              </div>
            </div>
          </div>
          
          <div class="analysis-section">
            <h5>Climate Variable Correlations</h5>
            <div class="correlation-grid">
              <div class="corr-item">
                <strong>Temperature-Humidity:</strong> 
                <span class="corr-value ${Math.abs(tempHumidityCorr) > 0.3 ? 'strong' : 'weak'}">
                  ${tempHumidityCorr.toFixed(3)}
                </span>
                <div class="corr-explanation">Clausius-Clapeyron relationship</div>
              </div>
              <div class="corr-item">
                <strong>Temperature-Solar:</strong> 
                <span class="corr-value ${Math.abs(tempSolarCorr) > 0.3 ? 'strong' : 'weak'}">
                  ${tempSolarCorr.toFixed(3)}
                </span>
                <div class="corr-explanation">Radiative forcing</div>
              </div>
              <div class="corr-item">
                <strong>Solar-Wind:</strong> 
                <span class="corr-value ${Math.abs(solarWindCorr) > 0.3 ? 'strong' : 'weak'}">
                  ${solarWindCorr.toFixed(3)}
                </span>
                <div class="corr-explanation">Thermal circulation</div>
              </div>
              <div class="corr-item">
                <strong>Humidity-Wind:</strong> 
                <span class="corr-value ${Math.abs(humidityWindCorr) > 0.3 ? 'strong' : 'weak'}">
                  ${humidityWindCorr.toFixed(3)}
                </span>
                <div class="corr-explanation">Advection patterns</div>
              </div>
            </div>
            <div class="corr-interpretation">
              <p><em>These correlations reflect fundamental atmospheric physics principles</em></p>
            </div>
          </div>
          
          <div class="analysis-section">
            <h5>Climate Regression Models</h5>
            <div class="regression-results">
              <div class="reg-model">
                <div class="reg-equation">
                  <strong>Solar-Temperature Model:</strong><br>
                  T = ${solarTempRegression.slope.toFixed(4)} × Solar + ${solarTempRegression.intercept.toFixed(2)}°C
                </div>
                <div class="reg-rsquared">
                  <strong>R² = ${solarTempRegression.rSquared.toFixed(3)}</strong>
                  <span class="rsquared-interpretation">
                    (${(solarTempRegression.rSquared * 100).toFixed(1)}% of temperature variance explained by solar radiation)
                  </span>
                </div>
              </div>
              
              <div class="reg-model">
                <div class="reg-equation">
                  <strong>Temperature-Humidity Model:</strong><br>
                  RH = ${tempHumidityRegression.slope.toFixed(4)} × T + ${tempHumidityRegression.intercept.toFixed(1)}%
                </div>
                <div class="reg-rsquared">
                  <strong>R² = ${tempHumidityRegression.rSquared.toFixed(3)}</strong>
                  <span class="rsquared-interpretation">
                    (${(tempHumidityRegression.rSquared * 100).toFixed(1)}% of humidity variance explained by temperature)
                  </span>
                </div>
              </div>
            </div>
            <div class="climate-context">
              <p><em>These models reflect atmospheric thermodynamics and are used in climate modeling worldwide</em></p>
            </div>
          </div>
          
          <div class="analysis-section">
            <h5>Climate Assessment</h5>
            <div class="climate-assessment">
              ${generateClimateAssessment(tempStats, humidityStats, solarStats, windStats, tempHumidityCorr, tempSolarCorr, solarWindCorr, humidityWindCorr)}
            </div>
          </div>
          
          <div class="analysis-section seasonal-section">
            <h5>Seasonal Temperature Analysis</h5>
            <div class="seasonal-grid">
              <div class="season-card winter">
                <h6>Winter</h6>
                <div>Mean: ${formatValueWithUnits(seasonalStats.winter.mean, 'temperature')}</div>
                <div>Range: ${formatValueWithUnits(seasonalStats.winter.range, 'temperature')}</div>
              </div>
              <div class="season-card spring">
                <h6>Spring</h6>
                <div>Mean: ${formatValueWithUnits(seasonalStats.spring.mean, 'temperature')}</div>
                <div>Range: ${formatValueWithUnits(seasonalStats.spring.range, 'temperature')}</div>
              </div>
              <div class="season-card summer">
                <h6>Summer</h6>
                <div>Mean: ${formatValueWithUnits(seasonalStats.summer.mean, 'temperature')}</div>
                <div>Range: ${formatValueWithUnits(seasonalStats.summer.range, 'temperature')}</div>
              </div>
              <div class="season-card autumn">
                <h6>Autumn</h6>
                <div>Mean: ${formatValueWithUnits(seasonalStats.autumn.mean, 'temperature')}</div>
                <div>Range: ${formatValueWithUnits(seasonalStats.autumn.range, 'temperature')}</div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }

    function updateClimateSummary() {
      if (!weatherData) return;
      
      const container = document.getElementById('climate-summary');
      const dryBulbData = getParameterData('Dry Bulb Temperature');
      const relativeHumidityData = getParameterData('Relative Humidity');
      const globalHorizontalRadiation = getParameterData('Global Horizontal Radiation');
      const windSpeedData = getParameterData('Wind Speed');
      
      const temperatures = dryBulbData.map(temp => convertValue(temp, 'temperature', 'SI'));
      const avgTemp = temperatures.reduce((a, b) => a + b, 0) / temperatures.length;
      const maxTemp = Math.max(...temperatures);
      const minTemp = Math.min(...temperatures);
      const avgRH = relativeHumidityData.reduce((a, b) => a + b, 0) / relativeHumidityData.length;
      const avgSolar = globalHorizontalRadiation.reduce((a, b) => a + b, 0) / globalHorizontalRadiation.length;
      const avgWind = windSpeedData.reduce((a, b) => a + b, 0) / windSpeedData.length;
      
      // Climate zone determination
      const climateZone = determineClimateZone(avgTemp, 0, 0, avgRH);
      
      // Climate characteristics
      let primaryClimate = '';
      let secondaryClimate = '';
      let designPriorities = [];
      
      if (avgTemp > 25) {
        primaryClimate = 'Hot Climate';
        designPriorities.push('Cooling dominates energy use');
        designPriorities.push('Solar heat gain control critical');
      } else if (avgTemp > 15) {
        primaryClimate = 'Temperate Climate';
        designPriorities.push('Mixed heating and cooling loads');
        designPriorities.push('Shoulder season optimization important');
      } else {
        primaryClimate = 'Cool Climate';
        designPriorities.push('Heating dominates energy use');
        designPriorities.push('Solar heat gain beneficial in winter');
      }
      
      if (avgRH > 70) {
        secondaryClimate = 'High Humidity';
        designPriorities.push('Moisture control essential');
        designPriorities.push('Mold and mildew prevention required');
      } else if (avgRH < 40) {
        secondaryClimate = 'Low Humidity';
        designPriorities.push('Static electricity control needed');
        designPriorities.push('Material shrinkage considerations');
      } else {
        secondaryClimate = 'Moderate Humidity';
        designPriorities.push('Standard moisture control adequate');
      }
      
      // Energy implications
      let energyImplications = [];
      
      if (maxTemp > 35) {
        energyImplications.push('Peak cooling loads require robust HVAC sizing');
      }
      if (minTemp < 0) {
        energyImplications.push('Freeze protection systems necessary');
      }
      if (avgSolar > 500) {
        energyImplications.push('High solar potential for renewable energy');
      }
      if (avgWind > 4) {
        energyImplications.push('Wind energy potential worth investigating');
      }
      
      const html = `
        <div class="climate-summary-content">
          <div class="summary-section">
            <h5>Climate Classification</h5>
            <div class="climate-zone-display">
              <strong>${climateZone.zone}</strong>
              <p>${climateZone.description}</p>
            </div>
          </div>
          
          <div class="summary-section">
            <h5>Climate Characteristics</h5>
            <div class="climate-chars">
              <span class="climate-primary">${primaryClimate}</span>
              <span class="climate-secondary">${secondaryClimate}</span>
            </div>
          </div>
          
          <div class="summary-section">
            <h5>Design Priorities</h5>
            <ul class="design-priorities">
              ${designPriorities.map(priority => `<li>${priority}</li>`).join('')}
            </ul>
          </div>
          
          <div class="summary-section">
            <h5>Energy Implications</h5>
            <ul class="energy-implications">
              ${energyImplications.map(implication => `<li>${implication}</li>`).join('')}
            </ul>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }

    function getParameterData(parameterName) {
      if (!weatherData) return [];
      
      const paramInfo = epwParameters[parameterName];
      if (!paramInfo) return [];
      
      // Map parameter names to data properties
      const parameterMap = {
        'Dry Bulb Temperature': 'dryBulbTemp',
        'Dew Point Temperature': 'dewPointTemp',
        'Relative Humidity': 'relativeHumidity',
        'Atmospheric Station Pressure': 'atmosphericPressure',
        'Extraterrestrial Horizontal Radiation': 'extraterrestrialHorizontalRadiation',
        'Extraterrestrial Direct Normal Radiation': 'extraterrestrialDirectNormalRadiation',
        'Horizontal Infrared Radiation': 'horizontalInfraredRadiation',
        'Global Horizontal Radiation': 'globalHorizontalRadiation',
        'Direct Normal Radiation': 'directNormalRadiation',
        'Diffuse Horizontal Radiation': 'diffuseHorizontalRadiation',
        'Global Horizontal Illuminance': 'globalHorizontalIlluminance',
        'Direct Normal Illuminance': 'directNormalIlluminance',
        'Diffuse Horizontal Illuminance': 'diffuseHorizontalIlluminance',
        'Zenith Luminance': 'zenithLuminance',
        'Wind Direction': 'windDirection',
        'Wind Speed': 'windSpeed',
        'Total Sky Cover': 'totalSkyCover',
        'Opaque Sky Cover': 'opaqueSkyCover',
        'Visibility': 'visibility',
        'Ceiling Height': 'ceilingHeight',
        'Present Weather Observation': 'presentWeatherObservation',
        'Present Weather Codes': 'presentWeatherCodes',
        'Precipitable Water': 'precipitableWater',
        'Aerosol Optical Depth': 'aerosolOpticalDepth',
        'Snow Depth': 'snowDepth',
        'Days Since Last Snowfall': 'daysSinceLastSnowfall',
        'Albedo': 'albedo',
        'Liquid Precipitation Depth': 'liquidPrecipitationDepth',
        'Liquid Precipitation Quantity': 'liquidPrecipitationQuantity'
      };
      
      const property = parameterMap[parameterName];
      if (!property) return [];
      
      return weatherData.data.map(d => d[property]);
    }

    // Chart control functions
    function resetZoom() {
      if (weatherChart) {
        weatherChart.resetZoom();
      }
    }

    function toggleDaily() {
      // Implementation would aggregate daily data
      alert('Daily aggregation feature to be implemented');
    }

    function toggleMonthly() {
      // Implementation would aggregate monthly data
      alert('Monthly aggregation feature to be implemented');
    }

    function toggleComfortZone() {
      showComfortZone = !showComfortZone;
      updatePsychrometricChart();
    }

    function toggleHumidityLines() {
      showHumidityLines = !showHumidityLines;
      updatePsychrometricChart();
    }

    // Tab switching
    function switchTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(tabName).classList.add('active');
      
      // Add active class to clicked tab
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      
      // Update charts if needed
      if (tabName === 'psychro' && weatherData) {
        setTimeout(() => updatePsychrometricChart(), 100);
      }
    }

    // Download functions
    function downloadSelectedCSV() {
      if (!weatherData) return;
      
      const data = getParameterData(currentParameter);
      const paramInfo = epwParameters[currentParameter];
      
      // Convert data if needed
      let convertedData = data;
      if (paramInfo.unit) {
        convertedData = data.map(value => convertValue(value, paramInfo.unit, 'SI'));
      }
      
      const unitLabel = paramInfo.unit ? unitLabels[currentUnits][paramInfo.unit] : '';
      
      let csv = `DateTime,${currentParameter} (${unitLabel})\n`;
      
      convertedData.forEach((value, index) => {
        const d = weatherData.data[index];
        const dateTime = `${d.month}/${d.day} ${d.hour}:${d.minute.toString().padStart(2, '0')}`;
        csv += `${dateTime},${value.toFixed(3)}\n`;
      });
      
      downloadCSVFile(csv, `${currentParameter}_${currentUnits}.csv`);
    }

    function downloadAllCSV() {
      if (!weatherData) return;
      
      let csv = 'DateTime';
      
      // Add headers for all parameters
      Object.keys(epwParameters).forEach(param => {
        const paramInfo = epwParameters[param];
        const unitLabel = paramInfo.unit ? unitLabels[currentUnits][paramInfo.unit] : '';
        csv += `,${param} (${unitLabel})`;
      });
      csv += '\n';
      
      // Add data rows
      weatherData.data.forEach((d, index) => {
        const dateTime = `${d.month}/${d.day} ${d.hour}:${d.minute.toString().padStart(2, '0')}`;
        csv += dateTime;
        
        Object.keys(epwParameters).forEach(param => {
          const paramInfo = epwParameters[param];
          const data = getParameterData(param);
          let value = data[index];
          
          // Convert units if necessary
          if (paramInfo.unit) {
            value = convertValue(value, paramInfo.unit, 'SI');
          }
          
          csv += `,${value.toFixed(3)}`;
        });
        csv += '\n';
      });
      
      downloadCSVFile(csv, `all_parameters_${currentUnits}.csv`);
    }

    function downloadBinCSV() {
      if (!weatherData) return;
      
      const paramInfo = epwParameters[currentParameter];
      let data = getParameterData(currentParameter);
      
      // Convert units if necessary
      if (paramInfo.unit) {
        data = data.map(value => convertValue(value, paramInfo.unit, 'SI'));
      }
      
      const binCount = parseInt(document.getElementById('binCount').value);
      const min = Math.min(...data);
      const max = Math.max(...data);
      const binSize = (max - min) / binCount;
      
      const bins = new Array(binCount).fill(0);
      const binRanges = [];
      
      for (let i = 0; i < binCount; i++) {
        const binStart = min + i * binSize;
        const binEnd = min + (i + 1) * binSize;
        binRanges.push(`${binStart.toFixed(2)}-${binEnd.toFixed(2)}`);
      }
      
      data.forEach(value => {
        const binIndex = Math.min(Math.floor((value - min) / binSize), binCount - 1);
        bins[binIndex]++;
      });
      
      const unitLabel = paramInfo.unit ? unitLabels[currentUnits][paramInfo.unit] : '';
      
      let csv = `Bin Range (${unitLabel}),Frequency\n`;
      binRanges.forEach((range, index) => {
        csv += `${range},${bins[index]}\n`;
      });
      
      downloadCSVFile(csv, `${currentParameter}_bins_${currentUnits}.csv`);
    }

    function downloadReport() {
      if (!weatherData) return;
      
      const report = generateClimateReport();
      downloadTextFile(report, `climate_analysis_report_${currentUnits}.txt`);
    }

    function generateClimateReport() {
      const location = weatherData.location;
      const dryBulbData = getParameterData('Dry Bulb Temperature');
      const relativeHumidityData = getParameterData('Relative Humidity');
      const globalHorizontalRadiation = getParameterData('Global Horizontal Radiation');
      const windSpeedData = getParameterData('Wind Speed');
      const windDirectionData = getParameterData('Wind Direction');
      
      const temperatures = dryBulbData.map(temp => convertValue(temp, 'temperature', 'SI'));
      const windSpeeds = windSpeedData.map(speed => convertValue(speed, 'windSpeed', 'SI'));
      const solarRadiation = globalHorizontalRadiation.map(rad => convertValue(rad, 'solarRadiation', 'SI'));
      
      const tempUnit = unitLabels[currentUnits].temperature;
      const windUnit = unitLabels[currentUnits].windSpeed;
      const solarUnit = unitLabels[currentUnits].solarRadiation;
      
      let report = `CLIMATE ANALYSIS REPORT\n`;
      report += `Generated: ${new Date().toLocaleString()}\n`;
      report += `Units: ${currentUnits === 'SI' ? 'S.I. (Metric)' : 'Imperial'}\n\n`;
      
      report += `LOCATION INFORMATION\n`;
      report += `File: ${weatherData.filename}\n`;
      report += `City: ${location.city}\n`;
      report += `State/Province: ${location.state}\n`;
      report += `Country: ${location.country}\n`;
      report += `Latitude: ${location.latitude.toFixed(2)}°\n`;
      report += `Longitude: ${location.longitude.toFixed(2)}°\n`;
      report += `Elevation: ${location.elevation.toFixed(0)} m\n`;
      report += `Time Zone: UTC${location.timezone >= 0 ? '+' : ''}${location.timezone}\n\n`;
      
      // Temperature Statistics
      const avgTemp = temperatures.reduce((a, b) => a + b, 0) / temperatures.length;
      const maxTemp = Math.max(...temperatures);
      const minTemp = Math.min(...temperatures);
      const extremeHeatThreshold = currentUnits === 'SI' ? 35 : 95;
      const extremeColdThreshold = currentUnits === 'SI' ? 0 : 32;
      const extremeHeatDays = temperatures.filter(t => t > extremeHeatThreshold).length / 24;
      const extremeColdDays = temperatures.filter(t => t < extremeColdThreshold).length / 24;
      
      report += `TEMPERATURE ANALYSIS\n`;
      report += `Annual Average: ${avgTemp.toFixed(1)} ${tempUnit}\n`;
      report += `Maximum: ${maxTemp.toFixed(1)} ${tempUnit}\n`;
      report += `Minimum: ${minTemp.toFixed(1)} ${tempUnit}\n`;
      report += `Range: ${(maxTemp - minTemp).toFixed(1)} ${tempUnit}\n`;
      report += `Extreme Heat Days (>${extremeHeatThreshold}${tempUnit}): ${extremeHeatDays.toFixed(0)}\n`;
      report += `Extreme Cold Days (<${extremeColdThreshold}${tempUnit}): ${extremeColdDays.toFixed(0)}\n\n`;
      
      // Humidity Analysis
      const avgRH = relativeHumidityData.reduce((a, b) => a + b, 0) / relativeHumidityData.length;
      const highHumidityHours = relativeHumidityData.filter(rh => rh > 70).length;
      const lowHumidityHours = relativeHumidityData.filter(rh => rh < 30).length;
      
      report += `HUMIDITY ANALYSIS\n`;
      report += `Annual Average RH: ${avgRH.toFixed(1)}%\n`;
      report += `Hours > 70% RH: ${highHumidityHours}\n`;
      report += `Hours < 30% RH: ${lowHumidityHours}\n\n`;
      
      // Solar Radiation Analysis
      const annualSolar = solarRadiation.reduce((a, b) => a + b, 0) / 1000; // Convert to kWh/m²
      const maxSolar = Math.max(...solarRadiation);
      const solarHours = solarRadiation.filter(s => s > (currentUnits === 'SI' ? 100 : 31.7)).length;
      
      report += `SOLAR RADIATION ANALYSIS\n`;
      report += `Annual Solar Radiation: ${annualSolar.toFixed(0)} ${unitLabels[currentUnits].solarRadiationAnnual}\n`;
      report += `Peak Solar Radiation: ${maxSolar.toFixed(0)} ${solarUnit}\n`;
      report += `Hours with Significant Solar (>100 W/m²): ${solarHours}\n\n`;
      
      // Wind Analysis
      const avgWind = windSpeeds.reduce((a, b) => a + b, 0) / windSpeeds.length;
      const maxWind = Math.max(...windSpeeds);
      
      // Prevailing wind direction
      const windDirectionFreq = {};
      const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
      windDirectionData.forEach(dir => {
        const dirIndex = Math.round(dir / 22.5) % 16;
        const dirName = directions[dirIndex];
        windDirectionFreq[dirName] = (windDirectionFreq[dirName] || 0) + 1;
      });
      const prevailingWind = Object.keys(windDirectionFreq).reduce((a, b) => windDirectionFreq[a] > windDirectionFreq[b] ? a : b);
      
      report += `WIND ANALYSIS\n`;
      report += `Average Wind Speed: ${avgWind.toFixed(1)} ${windUnit}\n`;
      report += `Maximum Wind Speed: ${maxWind.toFixed(1)} ${windUnit}\n`;
      report += `Prevailing Wind Direction: ${prevailingWind}\n\n`;
      
      // Climate Zone Classification
      report += `CLIMATE CLASSIFICATION\n`;
      const climateZone = determineClimateZone(avgTemp, extremeHeatDays, extremeColdDays, avgRH);
      report += `ASHRAE Climate Zone: ${climateZone.zone}\n`;
      report += `Description: ${climateZone.description}\n\n`;
      
      // DESIGN CONSIDERATIONS AND RECOMMENDATIONS
      report += `DESIGN CONSIDERATIONS AND RECOMMENDATIONS\n`;
      report += `================================================================\n\n`;
      
      // Building Orientation
      report += `BUILDING ORIENTATION:\n`;
      if (location.latitude > 0) {
        report += `• South-facing orientation recommended for solar gain in Northern Hemisphere\n`;
      } else {
        report += `• North-facing orientation recommended for solar gain in Southern Hemisphere\n`;
      }
      report += `• Consider prevailing wind direction (${prevailingWind}) for natural ventilation\n`;
      report += `• Main glazing should face away from extreme weather directions\n\n`;
      
      // Heating Considerations
      report += `HEATING DESIGN:\n`;
      if (extremeColdDays > 30) {
        report += `• High heating demand expected (${extremeColdDays.toFixed(0)} extreme cold days)\n`;
        report += `• Consider high-efficiency heating systems and superior insulation\n`;
        report += `• Thermal mass strategies recommended for temperature stabilization\n`;
      } else if (extremeColdDays > 7) {
        report += `• Moderate heating requirements (${extremeColdDays.toFixed(0)} cold days)\n`;
        report += `• Standard insulation levels appropriate\n`;
      } else {
        report += `• Minimal heating requirements (${extremeColdDays.toFixed(0)} cold days)\n`;
        report += `• Focus on cooling strategies instead\n`;
      }
      report += `\n`;
      
      // Cooling Considerations
      report += `COOLING DESIGN:\n`;
      if (extremeHeatDays > 30) {
        report += `• High cooling demand expected (${extremeHeatDays.toFixed(0)} extreme heat days)\n`;
        report += `• Consider high-efficiency cooling systems and superior solar control\n`;
        report += `• External shading devices essential\n`;
        report += `• Light-colored roof and wall materials recommended\n`;
      } else if (extremeHeatDays > 7) {
        report += `• Moderate cooling requirements (${extremeHeatDays.toFixed(0)} hot days)\n`;
        report += `• Natural ventilation strategies may be sufficient with mechanical backup\n`;
      } else {
        report += `• Low cooling requirements (${extremeHeatDays.toFixed(0)} hot days)\n`;
        report += `• Natural ventilation and passive cooling strategies recommended\n`;
      }
      report += `\n`;
      
      // Moisture Management
      report += `MOISTURE MANAGEMENT:\n`;
      if (avgRH > 70) {
        report += `• High humidity climate (${avgRH.toFixed(1)}% average RH)\n`;
        report += `• Vapor barriers and moisture control critical\n`;
        report += `• Mold and mildew prevention strategies essential\n`;
        report += `• Dehumidification systems may be required\n`;
      } else if (avgRH < 30) {
        report += `• Low humidity climate (${avgRH.toFixed(1)}% average RH)\n`;
        report += `• Humidification systems may be beneficial\n`;
        report += `• Static electricity control measures recommended\n`;
      } else {
        report += `• Moderate humidity levels (${avgRH.toFixed(1)}% average RH)\n`;
        report += `• Standard moisture management practices adequate\n`;
      }
      if (highHumidityHours > 2000) {
        report += `• ${highHumidityHours} hours of high humidity (>70% RH) annually\n`;
        report += `• Enhanced ventilation and moisture removal recommended\n`;
      }
      report += `\n`;
      
      // Solar Design
      report += `SOLAR DESIGN STRATEGIES:\n`;
      if (annualSolar > (currentUnits === 'SI' ? 1500 : 472)) {
        report += `• Excellent solar potential (${annualSolar.toFixed(0)} ${unitLabels[currentUnits].solarRadiationAnnual} annually)\n`;
        report += `• Solar panels and solar water heating highly recommended\n`;
        report += `• Daylighting strategies should include glare control\n`;
      } else if (annualSolar > (currentUnits === 'SI' ? 800 : 252)) {
        report += `• Good solar potential (${annualSolar.toFixed(0)} ${unitLabels[currentUnits].solarRadiationAnnual} annually)\n`;
        report += `• Solar systems viable with proper sizing\n`;
      } else {
        report += `• Limited solar potential (${annualSolar.toFixed(0)} ${unitLabels[currentUnits].solarRadiationAnnual} annually)\n`;
        report += `• Focus on maximizing available solar gain\n`;
      }
      report += `• ${solarHours} hours of significant solar radiation annually\n\n`;
      
      // Wind Design
      report += `WIND DESIGN CONSIDERATIONS:\n`;
      if (avgWind > (currentUnits === 'SI' ? 5 : 11.2)) {
        report += `• High wind speeds (${avgWind.toFixed(1)} ${windUnit} average)\n`;
        report += `• Wind-resistant construction required\n`;
        report += `• Natural ventilation potential excellent\n`;
        report += `• Wind energy generation may be viable\n`;
      } else if (avgWind > (currentUnits === 'SI' ? 2 : 4.5)) {
        report += `• Moderate wind speeds (${avgWind.toFixed(1)} ${windUnit} average)\n`;
        report += `• Good natural ventilation potential\n`;
      } else {
        report += `• Low wind speeds (${avgWind.toFixed(1)} ${windUnit} average)\n`;
        report += `• Mechanical ventilation may be necessary\n`;
      }
      report += `• Maximum wind speed: ${maxWind.toFixed(1)} ${windUnit}\n\n`;
      
      // Material Recommendations
      report += `MATERIAL RECOMMENDATIONS:\n`;
      if (extremeHeatDays > 20) {
        report += `• Light-colored, reflective materials for exterior surfaces\n`;
        report += `• High thermal mass materials for temperature moderation\n`;
      }
      if (extremeColdDays > 20) {
        report += `• High-performance insulation materials essential\n`;
        report += `• Thermal bridge prevention critical\n`;
      }
      if (avgRH > 70) {
        report += `• Moisture-resistant materials required\n`;
        report += `• Avoid materials prone to mold and rot\n`;
      }
      if (maxWind > (currentUnits === 'SI' ? 15 : 33.6)) {
        report += `• High wind-load rated materials and connections\n`;
        report += `• Impact-resistant glazing recommended\n`;
      }
      report += `\n`;
      
      // Energy Efficiency Recommendations
      report += `ENERGY EFFICIENCY PRIORITIES:\n`;
      const heatingLoad = extremeColdDays * 24;
      const coolingLoad = extremeHeatDays * 24;
      
      if (heatingLoad > coolingLoad) {
        report += `• Priority: Heating efficiency (${extremeColdDays.toFixed(0)} heating days vs ${extremeHeatDays.toFixed(0)} cooling days)\n`;
        report += `• Focus on insulation, air sealing, and efficient heating systems\n`;
      } else if (coolingLoad > heatingLoad) {
        report += `• Priority: Cooling efficiency (${extremeHeatDays.toFixed(0)} cooling days vs ${extremeColdDays.toFixed(0)} heating days)\n`;
        report += `• Focus on solar control, natural ventilation, and efficient cooling\n`;
      } else {
        report += `• Balanced heating and cooling requirements\n`;
        report += `• Comprehensive efficiency strategies recommended\n`;
      }
      
      if (annualSolar > (currentUnits === 'SI' ? 1200 : 378)) {
        report += `• Solar energy systems highly recommended\n`;
      }
      
      report += `\nThis analysis is based on typical meteorological year data and should be \n`;
      report += `supplemented with local building codes, standards, and professional design expertise.\n`;
      
      return report;
    }
    
    function determineClimateZone(avgTemp, hotDays, coldDays, avgRH) {
      // Use the same climate zone determination logic as the UI
      const tempC = currentUnits === 'SI' ? avgTemp : convertValue(avgTemp, 'temperature', 'Imperial');
      
      // Calculate temperature range from the weather data for consistency
      const dryBulbData = getParameterData('Dry Bulb Temperature');
      const temperatures = dryBulbData.map(temp => convertValue(temp, 'temperature', 'SI'));
      const maxTemp = Math.max(...temperatures);
      const minTemp = Math.min(...temperatures);
      const tempRangeC = maxTemp - minTemp;
      
      if (tempC >= 18) {
        if (tempRangeC < 20) {
          return { zone: '1A - Very Hot Humid', description: 'Very hot and humid climate with minimal temperature variation.' };
        } else {
          return { zone: '2A - Hot Humid', description: 'Hot and humid climate with moderate temperature variation.' };
        }
      } else if (tempC >= 13) {
        return { zone: '3A - Warm Humid', description: 'Warm climate with significant humidity levels.' };
      } else if (tempC >= 10) {
        return { zone: '4A - Mixed Humid', description: 'Mixed climate requiring both heating and cooling.' };
      } else if (tempC >= 7) {
        return { zone: '5A - Cool Humid', description: 'Cool climate with heating dominant but some cooling required.' };
      } else {
        return { zone: '6A - Cold Humid', description: 'Cold climate with heating dominant year-round.' };
      }
    }

    function downloadCSVFile(content, filename) {
      const blob = new Blob([content], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function downloadTextFile(content, filename) {
      const blob = new Blob([content], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function calculateCorrelation(xData, yData) {
      if (xData.length !== yData.length || xData.length === 0) return 0;
      
      const n = xData.length;
      const sumX = xData.reduce((a, b) => a + b, 0);
      const sumY = yData.reduce((a, b) => a + b, 0);
      const sumXY = xData.reduce((acc, x, i) => acc + x * yData[i], 0);
      const sumXX = xData.reduce((acc, x) => acc + x * x, 0);
      const sumYY = yData.reduce((acc, y) => acc + y * y, 0);
      
      const numerator = n * sumXY - sumX * sumY;
      const denominator = Math.sqrt((n * sumXX - sumX * sumX) * (n * sumYY - sumY * sumY));
      
      return denominator === 0 ? 0 : numerator / denominator;
    }
    
    function calculateRegression(xData, yData) {
      const n = xData.length;
      const sumX = xData.reduce((a, b) => a + b, 0);
      const sumY = yData.reduce((a, b) => a + b, 0);
      const sumXY = xData.reduce((acc, x, i) => acc + x * yData[i], 0);
      const sumXX = xData.reduce((acc, x) => acc + x * x, 0);
      
      const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;
      
      // Calculate R-squared
      const yMean = sumY / n;
      const ssTotal = yData.reduce((acc, y) => acc + Math.pow(y - yMean, 2), 0);
      const ssResidual = yData.reduce((acc, y, i) => {
        const predicted = slope * xData[i] + intercept;
        return acc + Math.pow(y - predicted, 2);
      }, 0);
      const rSquared = 1 - (ssResidual / ssTotal);
      
      return { slope, intercept, rSquared };
    }
    
    function calculateStats(data) {
      if (!data || data.length === 0) return { mean: 0, stdDev: 0, min: 0, max: 0, median: 0, range: 0 };
      
      const sorted = [...data].sort((a, b) => a - b);
      const mean = data.reduce((a, b) => a + b, 0) / data.length;
      const variance = data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / data.length;
      const stdDev = Math.sqrt(variance);
      const min = sorted[0];
      const max = sorted[sorted.length - 1];
      const median = sorted.length % 2 === 0 
        ? (sorted[sorted.length / 2 - 1] + sorted[sorted.length / 2]) / 2
        : sorted[Math.floor(sorted.length / 2)];
      const range = max - min;
      
      return { mean, stdDev, min, max, median, range };
    }
    
    function generateClimateAssessment(tempStats, humidityStats, solarStats, windStats, tempHumidityCorr, tempSolarCorr, solarWindCorr, humidityWindCorr) {
      const goodTraits = [];
      const badTraits = [];
      const neutralTraits = [];
      
      // Temperature assessment
      if (tempStats.mean >= 18 && tempStats.mean <= 26) {
        goodTraits.push("🌡️ **Comfortable Temperature Range**: Average temperature is ideal for human comfort and energy efficiency");
      } else if (tempStats.mean < 10) {
        badTraits.push("❄️ **Cold Climate**: Low average temperature may increase heating demands and limit outdoor activities");
      } else if (tempStats.mean > 30) {
        badTraits.push("🔥 **Hot Climate**: High average temperature increases cooling demands and heat stress risk");
      } else {
        neutralTraits.push("🌡️ **Moderate Temperature**: Temperature range is acceptable but may require seasonal HVAC adjustments");
      }
      
      // Temperature variability
      if (tempStats.stdDev < 5) {
        goodTraits.push("📊 **Stable Temperature**: Low temperature variation provides predictable conditions year-round");
      } else if (tempStats.stdDev > 15) {
        badTraits.push("📊 **High Temperature Variability**: Large temperature swings create challenging design conditions");
      }
      
      // Humidity assessment
      if (humidityStats.mean >= 40 && humidityStats.mean <= 60) {
        goodTraits.push("💧 **Optimal Humidity**: Relative humidity is in the ideal range for comfort and health");
      } else if (humidityStats.mean < 30) {
        badTraits.push("🏜️ **Dry Climate**: Low humidity may cause discomfort and increase static electricity issues");
      } else if (humidityStats.mean > 70) {
        badTraits.push("🌊 **High Humidity**: Elevated humidity increases cooling loads and mold/moisture risks");
      }
      
      // Solar radiation assessment
      if (solarStats.mean >= 150 && solarStats.mean <= 250) {
        goodTraits.push("☀️ **Good Solar Resource**: Excellent potential for daylighting and solar energy systems");
      } else if (solarStats.mean < 100) {
        neutralTraits.push("⛅ **Limited Solar**: Lower solar radiation may reduce natural lighting and solar energy potential");
      } else if (solarStats.mean > 300) {
        badTraits.push("🌞 **Intense Solar**: High solar radiation increases cooling loads and UV exposure concerns");
      }
      
      // Wind assessment
      if (windStats.mean >= 2 && windStats.mean <= 6) {
        goodTraits.push("💨 **Moderate Wind**: Good for natural ventilation and wind energy potential");
      } else if (windStats.mean < 1) {
        neutralTraits.push("🌀 **Low Wind**: Limited natural ventilation potential, may require mechanical systems");
      } else if (windStats.mean > 8) {
        badTraits.push("🌪️ **High Wind**: Strong winds may create structural concerns and discomfort");
      }
      
      // Correlation assessments (climate science relationships)
      if (Math.abs(tempSolarCorr) > 0.7) {
        goodTraits.push("📈 **Strong Solar-Temperature Correlation**: Predictable relationship useful for passive solar design");
      }
      
      if (Math.abs(tempHumidityCorr) < -0.5) {
        goodTraits.push("📉 **Good Temperature-Humidity Balance**: Inverse relationship helps moderate perceived temperature");
      } else if (tempHumidityCorr > 0.6) {
        badTraits.push("📈 **High Temp-Humidity Correlation**: Both high together increases heat index and discomfort");
      }
      
      if (Math.abs(solarWindCorr) > 0.5) {
        goodTraits.push("🌬️ **Solar-Wind Synergy**: Wind patterns correlate with solar intensity for natural cooling");
      }
      
      // Generate HTML
      let html = '<div class="traits-container">';
      
      if (goodTraits.length > 0) {
        html += '<div class="trait-section good-traits">';
        html += '<h6>✅ Positive Climate Traits</h6>';
        html += '<ul>';
        goodTraits.forEach(trait => html += `<li>${trait}</li>`);
        html += '</ul></div>';
      }
      
      if (badTraits.length > 0) {
        html += '<div class="trait-section bad-traits">';
        html += '<h6>⚠️ Climate Challenges</h6>';
        html += '<ul>';
        badTraits.forEach(trait => html += `<li>${trait}</li>`);
        html += '</ul></div>';
      }
      
      if (neutralTraits.length > 0) {
        html += '<div class="trait-section neutral-traits">';
        html += '<h6>ℹ️ Design Considerations</h6>';
        html += '<ul>';
        neutralTraits.forEach(trait => html += `<li>${trait}</li>`);
        html += '</ul></div>';
      }
      
      html += '</div>';
      return html;
    }

    // Utility functions
    function showLoading() {
      document.getElementById('loading').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }
  </script>
</body>
</html>
